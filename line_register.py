import streamlit as st
import pandas as pd
import streamlit.components.v1 as components
import gspread
from oauth2client.service_account import ServiceAccountCredentials
import os
import time

# --- Configuration ---
# ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå Credentials (‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà root ‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ)
SERVICE_ACCOUNT_FILE = "service_account.json" 

# 1. ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ö‡∏ô Google Drive (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πä‡∏∞)
GOOGLE_SHEET_FILENAME = "LINE User id for Database"

# 2. ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏ö/‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô (Tab Name)
GOOGLE_SHEET_TABNAME = "UserID"

# LIFF ID
LIFF_ID = "2008725340-YHOiWxtj" 

# --- Google Sheets Connection ---
def get_gsheet_client():
    """‡∏™‡∏£‡πâ‡∏≤‡∏á Connection ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets"""
    
    if not os.path.exists(SERVICE_ACCOUNT_FILE):
        st.error(f"‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå {SERVICE_ACCOUNT_FILE} ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ")
        return None

    scope = [
        "https://spreadsheets.google.com/feeds",
        "https://www.googleapis.com/auth/drive",
        "https://www.googleapis.com/auth/spreadsheets"
    ]
    try:
        creds = ServiceAccountCredentials.from_json_keyfile_name(SERVICE_ACCOUNT_FILE, scope)
        client = gspread.authorize(creds)
        return client
    except Exception as e:
        st.error(f"‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {e}")
        return None

def get_user_worksheet():
    """‡∏î‡∏∂‡∏á Worksheet ‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏ö"""
    client = get_gsheet_client()
    if not client: return None
    
    try:
        # 1. ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå (Workbook)
        sheet_file = client.open(GOOGLE_SHEET_FILENAME)
        
        # 2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ó‡πá‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏ö (Worksheet)
        try:
            worksheet = sheet_file.worksheet(GOOGLE_SHEET_TABNAME)
        except gspread.WorksheetNotFound:
            # ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÅ‡∏ó‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠ UserID ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡πá‡∏ö‡πÅ‡∏£‡∏Å‡∏™‡∏∏‡∏î‡πÅ‡∏ó‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            worksheet = sheet_file.sheet1
            # st.warning(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠ '{GOOGLE_SHEET_TABNAME}' ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡πá‡∏ö‡πÅ‡∏£‡∏Å '{worksheet.title}' ‡πÅ‡∏ó‡∏ô")

        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Header
        if not worksheet.row_values(1):
            worksheet.append_row(["‡∏ä‡∏∑‡πà‡∏≠", "‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•", "LINE User ID"])
            
        return worksheet

    except gspread.exceptions.SpreadsheetNotFound:
        st.error(f"‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå Google Sheet ‡∏ä‡∏∑‡πà‡∏≠ '{GOOGLE_SHEET_FILENAME}' ‡∏ö‡∏ô Google Drive")
        st.info(f"üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ö‡∏ô Drive ‡∏Ñ‡∏∑‡∏≠ '{GOOGLE_SHEET_FILENAME}' ‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏´‡πâ Service Account ‡πÅ‡∏•‡πâ‡∏ß")
        return None
    except Exception as e:
        st.error(f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î Sheet: {e}")
        return None

# --- User Management Functions ---

def check_if_user_registered(line_user_id):
    """
    ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ LINE ID ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÉ‡∏ô Google Sheet ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    """
    sheet = get_user_worksheet()
    if not sheet: return False, None
    
    try:
        records = sheet.get_all_records()
        df = pd.DataFrame(records)
        
        if "LINE User ID" not in df.columns:
            return False, None
            
        match = df[df["LINE User ID"].astype(str) == str(line_user_id)]
        
        if not match.empty:
            row = match.iloc[0]
            user_info = {
                "first_name": str(row["‡∏ä‡∏∑‡πà‡∏≠"]), 
                "last_name": str(row["‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"]), 
                "line_id": str(line_user_id)
            }
            return True, user_info
        return False, None
        
    except Exception as e: 
        st.error(f"‚ö†Ô∏è ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Sheet ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: {e}")
        return False, None

def save_new_user_to_gsheet(fname, lname, line_user_id):
    """‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á Google Sheet"""
    sheet = get_user_worksheet()
    if not sheet: return False, "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ"
    
    try:
        row_data = [str(fname), str(lname), str(line_user_id)]
        sheet.append_row(row_data)
        return True, "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"
    except Exception as e:
        return False, f"Google Sheet Error: {str(e)}"

# --- Helper Functions ---
def clean_string(val): return str(val).strip() if not pd.isna(val) else ""

def normalize_db_name_field(full_name_str):
    parts = clean_string(full_name_str).split()
    if len(parts) >= 2: return parts[0], " ".join(parts[1:])
    return (parts[0], "") if len(parts) == 1 else ("", "")

def check_registration_logic(df, input_fname, input_lname, input_id):
    i_fname = clean_string(input_fname)
    i_lname = clean_string(input_lname)
    i_id = clean_string(input_id)
    
    if not i_fname or not i_lname or not i_id: 
        return False, "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô", None
    
    if len(i_id) != 13 or not i_id.isdigit(): 
        return False, "‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å", None
    
    user_match = df[df['‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô'].astype(str).str.strip() == i_id]
    
    if user_match.empty: 
        return False, "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", None
    
    for _, row in user_match.iterrows():
        db_f, db_l = normalize_db_name_field(row['‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•'])
        
        match_fname = db_f.replace(" ", "") == i_fname.replace(" ", "")
        match_lname = db_l.replace(" ", "") == i_lname.replace(" ", "")
        
        if match_fname and match_lname:
            return True, "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á", row.to_dict()
            
    return False, "‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÅ‡∏ï‡πà‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)", None

# --- LIFF Script ---
def liff_initializer_component():
    if "line_user_id" in st.session_state or st.query_params.get("userid"):
        return

    # ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Script ‡πÉ‡∏´‡πâ‡∏£‡∏≠ DOM Ready ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ Error appendChild
    js_code = f"""
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        async function runLiff() {{
            try {{
                await liff.init({{ liffId: "{LIFF_ID}" }});
                if (liff.isLoggedIn()) {{
                    const profile = await liff.getProfile();
                    const userId = profile.userId;
                    const currentUrl = new URL(window.location.href);
                    
                    if (!currentUrl.searchParams.has("userid")) {{
                        currentUrl.searchParams.set("userid", userId);
                        window.top.location.href = currentUrl.toString();
                    }}
                }} else {{
                    liff.login();
                }}
            }} catch (err) {{
                document.getElementById("status-text").innerText = "Error: " + err;
                console.error("LIFF Init failed", err);
            }}
        }}

        // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏£‡∏±‡∏ô LIFF
        if (document.readyState === "loading") {{
            document.addEventListener("DOMContentLoaded", runLiff);
        }} else {{
            runLiff();
        }}
    </script>
    <div style="text-align:center; padding:20px; color: #666; background-color: #f0f2f6; border-radius: 10px;">
        <p id="status-text">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE... <br>(‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)</p>
    </div>
    """
    components.html(js_code, height=150)

# --- Admin Manager ---
def render_admin_line_manager():
    st.subheader("üì± ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô LINE (Google Sheets)")
    sheet = get_user_worksheet()
    if not sheet: return

    try:
        records = sheet.get_all_records()
        df = pd.DataFrame(records)
        st.dataframe(df, use_container_width=True)
        if st.button("‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"): st.rerun()
    except Exception as e:
        st.error(f"Error: {e}")

# --- Main Render Function ---
def render_registration_page(df):
    st.markdown("""
        <style>
        .reg-container {
            padding: 2rem; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-width: 500px; margin: auto; background-color: white;
        }
        .reg-header { color: #00B900; text-align: center; font-weight: bold; margin-bottom: 1.5rem; }
        .stButton>button { background-color: #00B900 !important; color: white !important; border-radius: 50px; height: 50px; font-size: 18px; border: none; }
        </style>
    """, unsafe_allow_html=True)
    
    qp_userid = st.query_params.get("userid", None)
    if qp_userid: 
        st.session_state["line_user_id"] = qp_userid
    
    if "line_user_id" not in st.session_state:
        if st.checkbox("Dev Mode: Mock UserID (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö)"):
            st.session_state["line_user_id"] = "U_TEST_MOCK_123456789"
            st.rerun()
        liff_initializer_component()
        return

    line_user_id = st.session_state["line_user_id"]
    
    st.caption(f"Connected LINE ID: {line_user_id}")

    with st.spinner(f"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•..."):
        is_registered, user_info = check_if_user_registered(line_user_id)
    
    if is_registered:
        found_rows = df[df['‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•'].str.contains(user_info['first_name'], na=False)]
        matched_user = None
        for _, row in found_rows.iterrows():
            db_f, db_l = normalize_db_name_field(row['‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•'])
            if db_f == user_info['first_name'] and db_l == user_info['last_name']:
                matched_user = row
                break
        
        if matched_user is not None:
             if not st.session_state.get('authenticated'):
                st.session_state.update({
                    'authenticated': True,
                    'pdpa_accepted': True,
                    'user_hn': matched_user['HN'],
                    'user_name': matched_user['‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•'],
                    'is_line_login': True
                })
                st.rerun()
             return
        else:
             st.error(f"‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á ‡∏Ñ‡∏∏‡∏ì{user_info['first_name']} ‡πÉ‡∏ô‡∏õ‡∏µ‡∏ô‡∏µ‡πâ")
             return

    if st.session_state.get('line_register_success', False):
        st.success("‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!")
        if st.button("‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏π‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û", type="primary", use_container_width=True): 
            st.rerun()
        return

    with st.container():
        st.markdown("<div class='reg-container'>", unsafe_allow_html=True)
        st.markdown("<h2 class='reg-header'>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏î‡∏π‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h2>", unsafe_allow_html=True)
        st.info("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å")
        
        pdpa_check = st.checkbox("‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (PDPA)")
        
        with st.form("line_reg_form"):
            f = st.text_input("‡∏ä‡∏∑‡πà‡∏≠ (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)")
            l = st.text_input("‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)")
            i = st.text_input("‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô (13 ‡∏´‡∏•‡∏±‡∏Å)", max_chars=13)
            sub = st.form_submit_button("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô", use_container_width=True)

        if sub:
            if not pdpa_check: 
                st.warning("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö PDPA")
            else:
                suc, msg, row = check_registration_logic(df, f, l, i)
                if suc:
                    with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Google Sheet..."):
                        save_suc, save_msg = save_new_user_to_gsheet(clean_string(f), clean_string(l), line_user_id)
                    
                    if save_suc:
                        st.session_state.update({
                            'line_register_success': True,
                            'authenticated': True,
                            'pdpa_accepted': True,
                            'user_hn': row['HN'],
                            'user_name': row['‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•']
                        })
                        st.rerun()
                    else: 
                        st.error(f"‚ùå {save_msg}")
                else: 
                    st.error(f"‚ùå {msg}")
        st.markdown("</div>", unsafe_allow_html=True)
