import streamlit as st
import sqlite3
import requests
import pandas as pd
import io
import tempfile
import html  # ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö html.escape()
import numpy as np

def is_empty(val):
    return str(val).strip().lower() in ["", "-", "none", "nan", "null"]

@st.cache_data(ttl=600)
def load_sqlite_data():
    try:
        file_id = "1HruO9AMrUfniC8hBWtumVdxLJayEc1Xr"
        download_url = f"https://drive.google.com/uc?export=download&id={file_id}"
        response = requests.get(download_url)
        response.raise_for_status()

        # ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏á temp file ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ sqlite3 ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ
        tmp = tempfile.NamedTemporaryFile(delete=False, suffix=".db")
        tmp.write(response.content)
        tmp.flush()
        tmp.close()

        conn = sqlite3.connect(tmp.name)
        df = pd.read_sql("SELECT * FROM health_data", conn)
        conn.close()

        # Strip & ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
        df.columns = df.columns.str.strip()
        df['‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô'] = df['‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô'].astype(str).str.strip()
        df['HN'] = df['HN'].astype(str).str.strip()
        df['‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•'] = df['‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•'].astype(str).str.strip()
        df['Year'] = df['Year'].astype(int)

        # ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢ / ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà - ‡∏´‡∏£‡∏∑‡∏≠ None
        df.replace(["-", "None", None], pd.NA, inplace=True)

        return df
    except Exception as e:
        st.error(f"‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {e}")
        st.stop()

df = load_sqlite_data()

# ==================== UI SEARCH FORM ====================
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û", layout="wide")
st.markdown("""
    <style>
    /* ‡∏õ‡∏¥‡∏î scrollbar ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ markdown ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß */
    div.stMarkdown {
        overflow: visible !important;
    }

    /* ‡∏õ‡∏¥‡∏î scrollbar ‡∏ö‡∏ô container ‡∏ó‡∏µ‡πà Streamlit ‡∏´‡πà‡∏≠‡πÉ‡∏´‡πâ */
    section.main > div {
        overflow-y: visible !important;
    }

    /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ wrap scroll container */
    [data-testid="stVerticalBlock"] {
        overflow: visible !important;
    }

    /* ‡∏õ‡∏¥‡∏î scrollbar ‡∏ó‡∏µ‡πà WebKit (Chrome/Safari) */
    ::-webkit-scrollbar {
        width: 0px;
        background: transparent;
    }

    /* ‡∏õ‡∏¥‡∏î scrollbar ‡∏Ç‡∏≠‡∏á container markdown ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ */
    div[style*="overflow: auto"] {
        overflow: visible !important;
    }

    div[style*="overflow-x: auto"] {
        overflow-x: visible !important;
    }

    div[style*="overflow-y: auto"] {
        overflow-y: visible !important;
    }
    </style>
""", unsafe_allow_html=True)

st.markdown("<h1 style='text-align:center;'>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h1>", unsafe_allow_html=True)
st.markdown("<h4 style='text-align:center; color:gray;'>- ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡πÄ‡∏ß‡∏ä‡∏Å‡∏£‡∏£‡∏° ‡∏£‡∏û.‡∏™‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ -</h4>", unsafe_allow_html=True)

with st.form("search_form"):
    col1, col2, col3 = st.columns(3)
    id_card = col1.text_input("‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô")
    hn = col2.text_input("HN")
    full_name = col3.text_input("‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•")
    submitted = st.form_submit_button("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤")

if submitted:
    query = df.copy()

    if id_card.strip():
        query = query[query["‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô"] == id_card.strip()]
    if hn.strip():
        try:
            hn_val = float(hn.strip())
            query = query[query["HN"].astype(float).apply(lambda x: np.isclose(x, hn_val))]
        except ValueError:
            st.error("‚ùå HN ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÄ‡∏ä‡πà‡∏ô 12345")
            st.stop()
    if full_name.strip():
        query = query[query["‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•"].str.strip() == full_name.strip()]

    # üßπ Reset ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà
    st.session_state.pop("selected_index", None)
    
    if query.empty:
        st.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á")
        st.session_state.pop("search_result", None)
    else:
        st.session_state["search_result"] = query

# ==================== SELECT YEAR FROM RESULTS ====================
if "search_result" in st.session_state:
    results_df = st.session_state["search_result"]

    available_years = sorted(results_df["Year"].dropna().unique().astype(int), reverse=True)
    selected_year = st.selectbox(
        "üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô",
        options=available_years,
        format_func=lambda y: f"‡∏û.‡∏®. {y}"
    )

    selected_hn = results_df.iloc[0]["HN"]  # ‡∏î‡∏∂‡∏á HN ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡πÄ‡∏à‡∏≠

    person_year_df = results_df[
        (results_df["Year"] == selected_year) &
        (results_df["HN"] == selected_hn)
    ]

    person_year_df = person_year_df.drop_duplicates(subset=["HN", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à"])

    exam_dates = person_year_df["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à"].dropna().unique()
    
    if len(exam_dates) > 1:
        for idx, row in person_year_df.iterrows():
            label = str(row["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à"]).strip() if pd.notna(row["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à"]) else f"‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà {idx+1}"
            if st.button(label, key=f"checkup_{idx}"):
                st.session_state["person_row"] = row.to_dict()
                st.session_state["selected_row_found"] = True
    elif len(person_year_df) == 1:
        st.session_state["person_row"] = person_year_df.iloc[0].to_dict()
        st.session_state["selected_row_found"] = True

    # ==================== ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å SQLite ====================

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πá‡∏ö (‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°)
def get_float(col, person_data):
    try:
        val = person_data.get(col, "")
        if is_empty(val):
            return None
        return float(str(val).replace(",", "").strip())
    except:
        return None

def flag(val, low=None, high=None, higher_is_better=False):
    try:
        val = float(str(val).replace(",", "").strip())
    except:
        return "-", False

    if higher_is_better and low is not None:
        return f"{val:.1f}", val < low

    if low is not None and val < low:
        return f"{val:.1f}", True
    if high is not None and val > high:
        return f"{val:.1f}", True

    # ‚úÖ ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á [low, high] ‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏ö
    return f"{val:.1f}", False

# ========== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡πÜ (‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ) ==========
def kidney_summary_gfr_only(gfr_raw):
    try:
        gfr = float(str(gfr_raw).replace(",", "").strip())
        if gfr == 0:
            return ""
        elif gfr < 60:
            return "‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÑ‡∏ï‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"
        else:
            return "‡∏õ‡∏Å‡∏ï‡∏¥"
    except:
        return ""

def kidney_advice_from_summary(summary_text):
    if summary_text == "‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÑ‡∏ï‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢":
        return (
            "‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÑ‡∏ï‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ "
            "‡∏•‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏Ñ‡πá‡∏° ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏™‡∏π‡∏á‡∏¢‡πà‡∏≠‡∏¢‡∏¢‡∏≤‡∏Å ‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥ 8-10 ‡πÅ‡∏Å‡πâ‡∏ß‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô "
            "‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏Å‡∏•‡∏±‡πâ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞ ‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ö‡∏ß‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå"
        )
    return ""

def fbs_advice(fbs_raw):
    if is_empty(fbs_raw):
        return ""
    try:
        value = float(str(fbs_raw).replace(",", "").strip())
        if value == 0:
            return ""
        elif 100 <= value < 106:
            return "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏ß‡∏≤‡∏ô ‡πÅ‡∏õ‡πâ‡∏á ‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢"
        elif 106 <= value < 126:
            return "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏ß‡∏≤‡∏ô ‡πÅ‡∏õ‡πâ‡∏á ‡∏Ç‡∏≠‡∏á‡∏°‡∏±‡∏ô ‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏ã‡πâ‡∏≥ ‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠"
        elif value >= 126:
            return "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏™‡∏π‡∏á ‡∏Ñ‡∏ß‡∏£‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£"
        else:
            return ""
    except:
        return ""

def summarize_liver(alp_val, sgot_val, sgpt_val):
    try:
        alp = float(alp_val)
        sgot = float(sgot_val)
        sgpt = float(sgpt_val)
        if alp == 0 or sgot == 0 or sgpt == 0:
            return "-"
        if alp > 120 or sgot > 36 or sgpt > 40:
            return "‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"
        return "‡∏õ‡∏Å‡∏ï‡∏¥"
    except:
        return "-"

def liver_advice(summary_text):
    if summary_text == "‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢":
        return "‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏™‡∏π‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ö‡∏ã‡πâ‡∏≥"
    elif summary_text == "‡∏õ‡∏Å‡∏ï‡∏¥":
        return ""
    return "-"

def uric_acid_advice(value_raw):
    try:
        value = float(value_raw)
        if value > 7.2:
            return "‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏ß‡∏£‡∏µ‡∏ô‡∏™‡∏π‡∏á ‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ô‡∏™‡∏±‡∏ï‡∏ß‡πå ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏∞‡πÄ‡∏• ‡πÅ‡∏•‡∏∞‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î‡∏Ç‡πâ‡∏≠"
        return ""
    except:
        return "-"

def summarize_lipids(chol_raw, tgl_raw, ldl_raw):
    try:
        chol = float(str(chol_raw).replace(",", "").strip())
        tgl = float(str(tgl_raw).replace(",", "").strip())
        ldl = float(str(ldl_raw).replace(",", "").strip())
        if chol == 0 and tgl == 0:
            return ""
        if chol >= 250 or tgl >= 250 or ldl >= 180:
            return "‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á"
        elif chol <= 200 and tgl <= 150:
            return "‡∏õ‡∏Å‡∏ï‡∏¥"
        else:
            return "‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"
    except:
        return ""

def lipids_advice(summary_text):
    if summary_text == "‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á":
        return (
            "‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á ‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏≠‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≠‡∏á‡∏ó‡∏≠‡∏î ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå "
            "‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠ ‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°"
        )
    elif summary_text == "‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢":
        return (
            "‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ ‡∏•‡∏î‡∏Ç‡∏≠‡∏á‡∏°‡∏±‡∏ô "
            "‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏Ç‡∏°‡∏±‡∏ô"
        )
    return ""

def cbc_advice(hb, hct, wbc, plt, sex="‡∏ä‡∏≤‡∏¢"):
    advice_parts = []

    try:
        hb_val = float(hb)
        hb_ref = 13 if sex == "‡∏ä‡∏≤‡∏¢" else 12
        if hb_val < hb_ref:
            advice_parts.append("‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Æ‡∏µ‡πÇ‡∏°‡πÇ‡∏Å‡∏•‡∏ö‡∏¥‡∏ô‡∏ï‡πà‡∏≥ ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏à‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ã‡πâ‡∏≥")
    except:
        pass

    try:
        hct_val = float(hct)
        hct_ref = 39 if sex == "‡∏ä‡∏≤‡∏¢" else 36
        if hct_val < hct_ref:
            advice_parts.append("‡∏Ñ‡πà‡∏≤‡∏Æ‡∏µ‡∏°‡∏≤‡πÇ‡∏ï‡∏Ñ‡∏£‡∏¥‡∏ï‡∏ï‡πà‡∏≥ ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡∏†‡∏≤‡∏ß‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏à‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°")
    except:
        pass

    try:
        wbc_val = float(wbc)
        if wbc_val < 4000:
            advice_parts.append("‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß‡∏ï‡πà‡∏≥ ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏†‡∏π‡∏°‡∏¥‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô‡∏•‡∏î ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°")
        elif wbc_val > 10000:
            advice_parts.append("‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß‡∏™‡∏π‡∏á ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö ‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏Ñ‡∏ß‡∏£‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå")
    except:
        pass

    try:
        plt_val = float(plt)
        if plt_val < 150000:
            advice_parts.append("‡πÄ‡∏Å‡∏•‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ï‡πà‡∏≥ ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏†‡∏≤‡∏ß‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å‡∏á‡πà‡∏≤‡∏¢ ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ã‡πâ‡∏≥")
        elif plt_val > 500000:
            advice_parts.append("‡πÄ‡∏Å‡∏•‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á ‡∏Ñ‡∏ß‡∏£‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°")
    except:
        pass

    return " ".join(advice_parts)

# === ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ===
def render_section_header(title, subtitle=None):
    if subtitle:
        full_title = f"{title} <span style='font-weight: normal;'>({subtitle})</span>"
    else:
        full_title = title

    return f"""
    <div style='
        background-color: #1b5e20;
        color: white;
        text-align: center;
        padding: 1rem 0.5rem;
        font-size: 20px;
        font-weight: bold;
        font-family: "Segoe UI", sans-serif;
        border-radius: 8px;
        margin-top: 2rem;
        margin-bottom: 1rem;
    '>
        {full_title}
    </div>
    """
if "person_row" in st.session_state:
    person = st.session_state["person_row"]
    year_display = person.get("Year", "-")

    def interpret_bp(sbp, dbp):
        try:
            sbp = float(sbp)
            dbp = float(dbp)
            if sbp == 0 or dbp == 0:
                return "-"
            if sbp >= 160 or dbp >= 100:
                return "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á"
            elif sbp >= 140 or dbp >= 90:
                return "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"
            elif sbp < 120 and dbp < 80:
                return "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥"
            else:
                return "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á"
        except:
            return "-"

    def combined_health_advice(bmi, sbp, dbp):
        if is_empty(bmi) and is_empty(sbp) and is_empty(dbp):
            return ""
    
        try:
            bmi = float(bmi)
        except:
            bmi = None
        try:
            sbp = float(sbp)
            dbp = float(dbp)
        except:
            sbp = dbp = None
    
        bmi_text = ""
        bp_text = ""
    
        if bmi is not None:
            if bmi > 30:
                bmi_text = "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏°‡∏≤‡∏Å"
            elif bmi >= 25:
                bmi_text = "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô"
            elif bmi < 18.5:
                bmi_text = "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô"
            else:
                bmi_text = "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥"
    
        if sbp is not None and dbp is not None:
            if sbp >= 160 or dbp >= 100:
                bp_text = "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å"
            elif sbp >= 140 or dbp >= 90:
                bp_text = "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á"
            elif sbp >= 120 or dbp >= 80:
                bp_text = "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏π‡∏á"
    
        if bmi is not None and "‡∏õ‡∏Å‡∏ï‡∏¥" in bmi_text and not bp_text:
            return "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏î‡∏µ ‡∏Ñ‡∏ß‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡πÑ‡∏õ"
        if not bmi_text and bp_text:
            return f"{bp_text} ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠"
        if bmi_text and bp_text:
            return f"{bmi_text} ‡πÅ‡∏•‡∏∞ {bp_text} ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢"
        return f"{bmi_text} ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°"

    # ===== ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å =====
    sbp = person.get("SBP", "")
    dbp = person.get("DBP", "")
    pulse = person.get("pulse", "-")
    weight = person.get("‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å", "-")
    height = person.get("‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á", "-")
    waist = person.get("‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß", "-")
    check_date = person.get("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à", "-")

    try:
        weight_val = float(str(weight).replace("‡∏Å‡∏Å.", "").strip())
        height_val = float(str(height).replace("‡∏ã‡∏°.", "").strip())
        bmi_val = weight_val / ((height_val / 100) ** 2)
    except:
        bmi_val = None

    # ‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
    try:
        sbp_int = int(float(sbp))
        dbp_int = int(float(dbp))
        bp_val = f"{sbp_int}/{dbp_int} ‡∏°.‡∏°.‡∏õ‡∏£‡∏≠‡∏ó"
    except:
        sbp_int = dbp_int = None
        bp_val = "-"
    
    if sbp_int is None or dbp_int is None:
        bp_desc = "-"
        bp_full = "-"
    else:
        bp_desc = interpret_bp(sbp, dbp)
        bp_full = f"{bp_val} - {bp_desc}" if bp_desc != "-" else bp_val

    # ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏µ‡∏û‡∏à‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏° ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°
    try:
        pulse_val = int(float(person.get("pulse", 0)))
    except:
        pulse_val = None

    pulse = f"{pulse_val} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ô‡∏≤‡∏ó‡∏µ" if pulse_val is not None else "-"
    weight = f"{weight} ‡∏Å‡∏Å." if not is_empty(weight) else "-"
    height = f"{height} ‡∏ã‡∏°." if not is_empty(height) else "-"
    waist = f"{waist} ‡∏ã‡∏°." if not is_empty(waist) else "-"

    advice_text = combined_health_advice(bmi_val, sbp, dbp)
    summary_advice = html.escape(advice_text) if advice_text else ""
    
    # ===== ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• =====
    st.markdown(f"""
    <div style="font-size: 18px; line-height: 1.8; color: inherit; padding: 24px 8px;">
        <div style="text-align: center; font-size: 22px; font-weight: bold;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</div>
        <div style="text-align: center;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à: {check_date or "-"}</div>
        <div style="text-align: center; margin-top: 10px;">
            ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ 201 ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà 11 ‡∏ñ‡∏ô‡∏ô ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà - ‡∏û‡∏£‡πâ‡∏≤‡∏ß ‡∏ï‡∏≥‡∏ö‡∏•‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏≤‡∏£ ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏™‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà 50290<br>
            ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡πÄ‡∏ß‡∏ä‡∏Å‡∏£‡∏£‡∏° ‡πÇ‡∏ó‡∏£ 053 921 199 ‡∏ï‡πà‡∏≠ 167
        </div>
        <hr style="margin: 24px 0;">
        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 32px; margin-bottom: 20px; text-align: center;">
            <div><b>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</b> {person.get('‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•', '-')}</div>
            <div><b>‡∏≠‡∏≤‡∏¢‡∏∏:</b> {str(int(float(person.get('‡∏≠‡∏≤‡∏¢‡∏∏')))) if str(person.get('‡∏≠‡∏≤‡∏¢‡∏∏')).replace('.', '', 1).isdigit() else person.get('‡∏≠‡∏≤‡∏¢‡∏∏', '-')} ‡∏õ‡∏µ</div>
            <div><b>‡πÄ‡∏û‡∏®:</b> {person.get('‡πÄ‡∏û‡∏®', '-')}</div>
            <div><b>HN:</b> {str(int(float(person.get('HN')))) if str(person.get('HN')).replace('.', '', 1).isdigit() else person.get('HN', '-')}</div>
            <div><b>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</b> {person.get('‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô', '-')}</div>
        </div>
        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 32px; margin-bottom: 16px; text-align: center;">
            <div><b>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å:</b> {weight}</div>
            <div><b>‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á:</b> {height}</div>
            <div><b>‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß:</b> {waist}</div>
            <div><b>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï:</b> {bp_full}</div>
            <div><b>‡∏ä‡∏µ‡∏û‡∏à‡∏£:</b> {pulse}</div>
        </div>
        {f"<div style='margin-top: 16px; text-align: center;'><b>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</b> {summary_advice}</div>" if summary_advice else ""}
    </div>
    """, unsafe_allow_html=True)

# ==================== ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å SQLite ====================

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πá‡∏ö (‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°)
def get_float(col, person_data):
    try:
        val = person_data.get(col, "")
        if is_empty(val):
            return None
        return float(str(val).replace(",", "").strip())
    except:
        return None

def flag(val, low=None, high=None, higher_is_better=False):
    try:
        val = float(str(val).replace(",", "").strip())
    except:
        return "-", False

    if higher_is_better and low is not None:
        return f"{val:.1f}", val < low

    if low is not None and val < low:
        return f"{val:.1f}", True
    if high is not None and val > high:
        return f"{val:.1f}", True

    # ‚úÖ ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á [low, high] ‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏ö
    return f"{val:.1f}", False

if "person_row" in st.session_state:
    person = st.session_state["person_row"]
    sex = str(person.get("‡πÄ‡∏û‡∏®", "")).strip()

    if sex not in ["‡∏ä‡∏≤‡∏¢", "‡∏´‡∏ç‡∏¥‡∏á"]:
        st.warning("‚ö†Ô∏è ‡πÄ‡∏û‡∏®‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô")
        sex = "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"

    if sex == "‡∏´‡∏ç‡∏¥‡∏á":
        hb_low = 12
        hct_low = 36
    elif sex == "‡∏ä‡∏≤‡∏¢":
        hb_low = 13
        hct_low = 39
    else:
        hb_low = 12
        hct_low = 36

    cbc_config = [
        ("‡∏Æ‡∏µ‡πÇ‡∏°‡πÇ‡∏Å‡∏•‡∏ö‡∏¥‡∏ô (Hb)", "Hb(%)", "‡∏ä‡∏≤‡∏¢ > 13, ‡∏´‡∏ç‡∏¥‡∏á > 12 g/dl", hb_low, None),
        ("‡∏Æ‡∏µ‡∏°‡∏≤‡πÇ‡∏ó‡∏Ñ‡∏£‡∏¥‡∏ï (Hct)", "HCT", "‡∏ä‡∏≤‡∏¢ > 39%, ‡∏´‡∏ç‡∏¥‡∏á > 36%", hct_low, None),
        ("‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß (wbc)", "WBC (cumm)", "4,000 - 10,000 /cu.mm", 4000, 10000),
        ("‡∏ô‡∏¥‡∏ß‡πÇ‡∏ó‡∏£‡∏ü‡∏¥‡∏• (Neutrophil)", "Ne (%)", "43 - 70%", 43, 70),
        ("‡∏•‡∏¥‡∏°‡πÇ‡∏ü‡πÑ‡∏ã‡∏ï‡πå (Lymphocyte)", "Ly (%)", "20 - 44%", 20, 44),
        ("‡πÇ‡∏°‡πÇ‡∏ô‡πÑ‡∏ã‡∏ï‡πå (Monocyte)", "M", "3 - 9%", 3, 9),
        ("‡∏≠‡∏µ‡πÇ‡∏≠‡∏ã‡∏¥‡πÇ‡∏ô‡∏ü‡∏¥‡∏• (Eosinophil)", "Eo", "0 - 9%", 0, 9),
        ("‡πÄ‡∏ö‡πÇ‡∏ã‡∏ü‡∏¥‡∏• (Basophil)", "BA", "0 - 3%", 0, 3),
        ("‡πÄ‡∏Å‡∏•‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î (Platelet)", "Plt (/mm)", "150,000 - 500,000 /cu.mm", 150000, 500000),
    ]

    cbc_rows = []
    for label, col, norm, low, high in cbc_config:
        val = get_float(col, person)
        result, is_abn = flag(val, low, high)
        cbc_rows.append([(label, is_abn), (result, is_abn), (norm, is_abn)])

    blood_config = [
        ("FBS", "FBS", "74 - 106 mg/dl", 74, 106),
        ("Uric Acid", "Uric Acid", "2.6 - 7.2 mg%", 2.6, 7.2),
        ("ALK", "ALP", "30 - 120 U/L", 30, 120),
        ("SGOT", "SGOT", "< 37 U/L", None, 37),
        ("SGPT", "SGPT", "< 41 U/L", None, 41),
        ("CHOL", "CHOL", "150 - 200 mg/dl", 150, 200),
        ("TGL", "TGL", "35 - 150 mg/dl", 35, 150),
        ("HDL", "HDL", "> 40 mg/dl", 40, None, True),
        ("LDL", "LDL", "0 - 160 mg/dl", 0, 160),
        ("BUN", "BUN", "7.9 - 20 mg/dl", 7.9, 20),
        ("Cr", "Cr", "0.5 - 1.17 mg/dl", 0.5, 1.17),
        ("GFR", "GFR", "> 60 mL/min", 60, None, True),
    ]

    blood_rows = []
    for label, col, norm, low, high, *opt in blood_config:
        higher = opt[0] if opt else False
        val = get_float(col, person)
        result, is_abn = flag(val, low, high, higher)
        blood_rows.append([(label, is_abn), (result, is_abn), (norm, is_abn)])

    def render_lab_section(title, subtitle, headers, rows):
        style = """
        <style>
            .lab-container {
                background-color: var(--background-color);  /* ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏à‡∏≤‡∏Å‡∏ò‡∏µ‡∏° */
                margin-top: 1rem;
            }
            .lab-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 16px;
                font-family: "Segoe UI", sans-serif;
                color: var(--text-color);  /* ‡πÅ‡∏ó‡∏ô white */
            }
            .lab-table thead th {
                background-color: var(--secondary-background-color);
                color: var(--text-color);
                padding: 4px 6px;
                text-align: center;
                font-weight: bold;
                border: 1px solid transparent;
            }
            .lab-table td {
                padding: 4px 6px;
                border: 1px solid transparent;
                text-align: center;
            }
            .lab-abn {
                background-color: rgba(255, 64, 64, 0.25); /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á */
            }
            .lab-row {
                background-color: rgba(255,255,255,0.02);
            }
        </style>
        """
        html = f"""
        <div style='
            background-color: #1b5e20;
            color: white;
            text-align: center;
            padding: 1rem 0.5rem;
            font-size: 20px;
            font-weight: bold;
            font-family: "Segoe UI", sans-serif;
            border-radius: 8px;
            margin-bottom: 1rem;
        '>
            {title}<br><span style='font-size: 18px; font-weight: normal;'>({subtitle})</span>
        </div>
        """
    
        html += "<div class='lab-container'><table class='lab-table'>"
        html += "<thead><tr>"
        for i, h in enumerate(headers):
            align = "left" if i in [0, 2] else "center"
            html += f"<th style='text-align: {align};'>{h}</th>"
        html += "</tr></thead><tbody>"
    
        for row in rows:
            is_abn = any(flag for _, flag in row)
            row_class = "lab-abn" if is_abn else "lab-row"
            
            html += f"<tr>"
            html += f"<td class='{row_class}' style='text-align: left;'>{row[0][0]}</td>"  # ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à
            html += f"<td class='{row_class}'>{row[1][0]}</td>"  # ‡∏ú‡∏•
            html += f"<td class='{row_class}' style='text-align: left;'>{row[2][0]}</td>"  # ‡∏Ñ‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥
            html += f"</tr>"
        html += "</tbody></table></div>"
        return style + html

    left_spacer, col1, col2, right_spacer = st.columns([1, 3, 3, 1])

    with col1:
        st.markdown(render_lab_section("‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à CBC", "Complete Blood Count", ["‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à", "‡∏ú‡∏•", "‡∏Ñ‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥"], cbc_rows), unsafe_allow_html=True)
    
    with col2:
        st.markdown(render_lab_section("‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏Ñ‡∏°‡∏µ‡πÄ‡∏•‡∏∑‡∏≠‡∏î", "Blood Chemistry", ["‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à", "‡∏ú‡∏•", "‡∏Ñ‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥"], blood_rows), unsafe_allow_html=True)

    # ==================== ‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ====================
    gfr_raw = person.get("GFR", "")
    fbs_raw = person.get("FBS", "")
    alp_raw = person.get("ALP", "")
    sgot_raw = person.get("SGOT", "")
    sgpt_raw = person.get("SGPT", "")
    uric_raw = person.get("Uric Acid", "")
    chol_raw = person.get("CHOL", "")
    tgl_raw = person.get("TGL", "")
    ldl_raw = person.get("LDL", "")

    advice_list = []
    kidney_summary = kidney_summary_gfr_only(gfr_raw)
    advice_list.append(kidney_advice_from_summary(kidney_summary))
    advice_list.append(fbs_advice(fbs_raw))
    advice_list.append(liver_advice(summarize_liver(alp_raw, sgot_raw, sgpt_raw)))
    advice_list.append(uric_acid_advice(uric_raw))
    advice_list.append(lipids_advice(summarize_lipids(chol_raw, tgl_raw, ldl_raw)))
    advice_list.append(cbc_advice(
        person.get("Hb(%)", ""), 
        person.get("HCT", ""), 
        person.get("WBC (cumm)", ""), 
        person.get("Plt (/mm)", ""),
        sex=sex
    ))

    from collections import OrderedDict

    def merge_final_advice_grouped(messages):
        groups = {
            "FBS": [], "‡πÑ‡∏ï": [], "‡∏ï‡∏±‡∏ö": [], "‡∏¢‡∏π‡∏£‡∏¥‡∏Ñ": [], "‡πÑ‡∏Ç‡∏°‡∏±‡∏ô": [], "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": []
        }

        for msg in messages:
            if not msg or msg.strip() in ["-", ""]:
                continue
            if "‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•" in msg:
                groups["FBS"].append(msg)
            elif "‡πÑ‡∏ï" in msg:
                groups["‡πÑ‡∏ï"].append(msg)
            elif "‡∏ï‡∏±‡∏ö" in msg:
                groups["‡∏ï‡∏±‡∏ö"].append(msg)
            elif "‡∏û‡∏¥‡∏ß‡∏£‡∏µ‡∏ô" in msg or "‡∏¢‡∏π‡∏£‡∏¥‡∏Ñ" in msg:
                groups["‡∏¢‡∏π‡∏£‡∏¥‡∏Ñ"].append(msg)
            elif "‡πÑ‡∏Ç‡∏°‡∏±‡∏ô" in msg:
                groups["‡πÑ‡∏Ç‡∏°‡∏±‡∏ô"].append(msg)
            else:
                groups["‡∏≠‡∏∑‡πà‡∏ô‡πÜ"].append(msg)

        icon_map = {
            "FBS": "üç¨", "‡πÑ‡∏ï": "üíß", "‡∏ï‡∏±‡∏ö": "ü´Ä",
            "‡∏¢‡∏π‡∏£‡∏¥‡∏Ñ": "ü¶¥", "‡πÑ‡∏Ç‡∏°‡∏±‡∏ô": "üßà", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": "üìù"
        }

        output = []
        for title, msgs in groups.items():
            if msgs:
                unique_msgs = list(OrderedDict.fromkeys(msgs))
                output.append(f"<b>{icon_map.get(title)} {title}:</b> {' '.join(unique_msgs)}")

        if not output:
            return "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à"

        return "<div style='margin-bottom: 0.75rem;'>" + "</div><div style='margin-bottom: 0.75rem;'>".join(output) + "</div>"

    spacer_l, main_col, spacer_r = st.columns([1, 6, 1])

    with main_col:
        st.markdown(f"""
        <div style="
            background-color: rgba(33, 150, 243, 0.15);
            padding: 2rem 2.5rem;
            border-radius: 10px;
            font-size: 16px;
            line-height: 1.5;
            color: inherit;
        ">
            <div style="font-size: 18px; font-weight: bold; margin-bottom: 1.5rem;">
                üìã ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
            </div>
            {merge_final_advice_grouped(advice_list)}
        </div>
        """, unsafe_allow_html=True)

    # ==================== Urinalysis Section ====================
    def render_section_header(title, subtitle=None):
        if subtitle:
            full_title = f"{title} <span style='font-weight: normal;'>({subtitle})</span>"
        else:
            full_title = title
    
        return f"""
        <div style='
            background-color: #1b5e20;
            color: white;
            text-align: center;
            padding: 1rem 0.5rem;
            font-size: 20px;
            font-weight: bold;
            font-family: "Segoe UI", sans-serif;
            border-radius: 8px;
            margin-top: 2rem;
            margin-bottom: 1rem;
        '>
            {full_title}
        </div>
        """
    
    def safe_value(val):
        val = str(val or "").strip()
        if val.lower() in ["", "nan", "none", "-"]:
            return "-"
        return val
    
    with st.container():
        left_spacer_ua, col_ua_left, col_ua_right, right_spacer_ua = st.columns([1, 3, 3, 1])
    
    if "person_row" in st.session_state:
        person = st.session_state["person_row"]
        sex = person.get("‡πÄ‡∏û‡∏®", "-").strip()
        year_selected = person.get("Year", "-")
    
        alb_raw = person.get("Alb", "-")
        sugar_raw = person.get("sugar", "-")
        rbc_raw = person.get("RBC1", "-")
        wbc_raw = person.get("WBC1", "-")
    
        def interpret_alb(value):
            val = str(value).strip().lower()
            if val == "negative":
                return "‡πÑ‡∏°‡πà‡∏û‡∏ö"
            elif val in ["trace", "1+", "2+"]:
                return "‡∏û‡∏ö‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"
            elif val in ["3+", "4+"]:
                return "‡∏û‡∏ö‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞"
            return "-"
    
        def interpret_sugar(value):
            val = str(value).strip().lower()
            if val == "negative":
                return "‡πÑ‡∏°‡πà‡∏û‡∏ö"
            elif val == "trace":
                return "‡∏û‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"
            elif val in ["1+", "2+", "3+", "4+", "5+", "6+"]:
                return "‡∏û‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞"
            return "-"
    
        def parse_range_or_number(val):
            val = val.replace("cell/hpf", "").replace("cells/hpf", "").replace("cell", "").strip().lower()
            try:
                if "-" in val:
                    low, high = map(float, val.split("-"))
                    return low, high
                else:
                    num = float(val)
                    return num, num
            except:
                return None, None
    
        def interpret_rbc(value):
            val = str(value or "").strip().lower()
            if val in ["-", "", "none", "nan"]:
                return "-"
            low, high = parse_range_or_number(val)
            if high is None:
                return value
            if high <= 2:
                return "‡∏õ‡∏Å‡∏ï‡∏¥"
            elif high <= 5:
                return "‡∏û‡∏ö‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÅ‡∏î‡∏á‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"
            else:
                return "‡∏û‡∏ö‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÅ‡∏î‡∏á‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞"
    
        def interpret_wbc(value):
            val = str(value or "").strip().lower()
            if val in ["-", "", "none", "nan"]:
                return "-"
            low, high = parse_range_or_number(val)
            if high is None:
                return value
            if high <= 5:
                return "‡∏õ‡∏Å‡∏ï‡∏¥"
            elif high <= 10:
                return "‡∏û‡∏ö‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"
            else:
                return "‡∏û‡∏ö‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞"
    
        def advice_urine(sex, alb, sugar, rbc, wbc):
            alb_t = interpret_alb(alb)
            sugar_t = interpret_sugar(sugar)
            rbc_t = interpret_rbc(rbc)
            wbc_t = interpret_wbc(wbc)
    
            if all(x in ["-", "‡∏õ‡∏Å‡∏ï‡∏¥", "‡πÑ‡∏°‡πà‡∏û‡∏ö", "‡∏û‡∏ö‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢", "‡∏û‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"]
                   for x in [alb_t, sugar_t, rbc_t, wbc_t]):
                return ""
    
            if "‡∏û‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞" in sugar_t and "‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢" not in sugar_t:
                return "‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
    
            if sex == "‡∏´‡∏ç‡∏¥‡∏á" and "‡∏û‡∏ö‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÅ‡∏î‡∏á" in rbc_t and "‡∏õ‡∏Å‡∏ï‡∏¥" in wbc_t:
                return "‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏õ‡∏ô‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ã‡πâ‡∏≥"
    
            if sex == "‡∏ä‡∏≤‡∏¢" and "‡∏û‡∏ö‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÅ‡∏î‡∏á" in rbc_t and "‡∏õ‡∏Å‡∏ï‡∏¥" in wbc_t:
                return "‡∏û‡∏ö‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÅ‡∏î‡∏á‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞ ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
    
            if "‡∏û‡∏ö‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß" in wbc_t and "‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢" not in wbc_t:
                return "‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ã‡πâ‡∏≥"
    
            return "‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡∏ã‡πâ‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•"
    
        urine_data = [
            ("‡∏™‡∏µ (Colour)", person.get("Color", "-"), "Yellow, Pale Yellow"),
            ("‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• (Sugar)", sugar_raw, "Negative"),
            ("‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô (Albumin)", alb_raw, "Negative, trace"),
            ("‡∏Å‡∏£‡∏î-‡∏î‡πà‡∏≤‡∏á (pH)", person.get("pH", "-"), "5.0 - 8.0"),
            ("‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡πà‡∏ß‡∏á‡∏à‡∏≥‡πÄ‡∏û‡∏≤‡∏∞ (Sp.gr)", person.get("Spgr", "-"), "1.003 - 1.030"),
            ("‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÅ‡∏î‡∏á (RBC)", rbc_raw, "0 - 2 cell/HPF"),
            ("‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß (WBC)", wbc_raw, "0 - 5 cell/HPF"),
            ("‡πÄ‡∏ã‡∏•‡∏•‡πå‡πÄ‡∏¢‡∏∑‡πà‡∏≠‡∏ö‡∏∏‡∏ú‡∏¥‡∏ß (Squam.epit.)", person.get("SQ-epi", "-"), "0 - 10 cell/HPF"),
            ("‡∏≠‡∏∑‡πà‡∏ô‡πÜ", person.get("ORTER", "-"), "-"),
        ]
    
        st.markdown("""
        <style>
            .urine-table, .lab-table {
                width: 100%;
                table-layout: fixed;
            }
            .urine-table td, .lab-table td {
                overflow-wrap: break-word;
            }
            .stMarkdown {
                overflow-x: auto;
            }
        </style>
        """, unsafe_allow_html=True)
    
        with col_ua_left:
            st.markdown(render_section_header("‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞", "Urinalysis"), unsafe_allow_html=True)
            df_urine = pd.DataFrame(urine_data, columns=["‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à", "‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à", "‡∏Ñ‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥"])
    
            def is_urine_abnormal(test_name, value, normal_range):
                val = str(value or "").strip().lower()
                if val in ["", "-", "none", "nan", "null"]:
                    return False
    
                if test_name == "‡∏Å‡∏£‡∏î-‡∏î‡πà‡∏≤‡∏á (pH)":
                    try:
                        return not (5.0 <= float(val) <= 8.0)
                    except:
                        return True
    
                if test_name == "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡πà‡∏ß‡∏á‡∏à‡∏≥‡πÄ‡∏û‡∏≤‡∏∞ (Sp.gr)":
                    try:
                        return not (1.003 <= float(val) <= 1.030)
                    except:
                        return True
    
                if test_name == "‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÅ‡∏î‡∏á (RBC)":
                    return "‡∏û‡∏ö" in interpret_rbc(val).lower()
    
                if test_name == "‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß (WBC)":
                    return "‡∏û‡∏ö" in interpret_wbc(val).lower()
    
                if test_name == "‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• (Sugar)":
                    return interpret_sugar(val).lower() != "‡πÑ‡∏°‡πà‡∏û‡∏ö"
    
                if test_name == "‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô (Albumin)":
                    return interpret_alb(val).lower() != "‡πÑ‡∏°‡πà‡∏û‡∏ö"
    
                if test_name == "‡∏™‡∏µ (Colour)":
                    return val not in ["yellow", "pale yellow", "colorless", "paleyellow", "light yellow"]
    
                return False
    
            def render_urine_html_table(df):
                style = """
                <style>
                    .urine-container {
                        background-color: var(--background-color);
                        margin-top: 1rem;
                    }
                    .urine-table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 16px;
                        font-family: "Segoe UI", sans-serif;
                    }
                    .urine-table thead th {
                        background-color: var(--secondary-background-color);
                        color: var(--text-color);
                        padding: 8px 10px;
                        text-align: center;
                        font-weight: bold;
                        border: 1px solid transparent;
                    }
                    .urine-table td {
                        padding: 8px 10px;
                        border: 1px solid transparent;  /* üëà ‡πÄ‡∏™‡πâ‡∏ô‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ï‡πà‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ */
                        text-align: center;
                        color: var(--text-color);
                    }
                    .urine-abn {
                        background-color: rgba(255, 64, 64, 0.25);
                    }
                    .urine-row {
                        background-color: rgba(255,255,255,0.02);
                    }
                </style>
                """
                html = "<div class='urine-container'><table class='urine-table'>"
                html += "<thead><tr>"
                html += "<th style='text-align: left;'>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</th>"
                html += "<th>‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à</th>"
                html += "<th style='text-align: left;'>‡∏Ñ‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥</th>"
                html += "</tr></thead><tbody>"
                
                for _, row in df.iterrows():
                    is_abn = is_urine_abnormal(row["‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à"], row["‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à"], row["‡∏Ñ‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥"])
                    css_class = "urine-abn" if is_abn else "urine-row"
                    html += f"<tr class='{css_class}'>"
                    html += f"<td style='text-align: left;'>{row['‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à']}</td>"
                    html += f"<td>{safe_value(row['‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à'])}</td>"
                    html += f"<td style='text-align: left;'>{row['‡∏Ñ‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥']}</td>"
                    html += "</tr>"
                html += "</tbody></table></div>"
                return style + html
    
            st.markdown(render_urine_html_table(df_urine), unsafe_allow_html=True)
    
            def is_all_urine_data_missing(data):
                return all(str(x).strip().lower() in ["", "-", "nan", "none"] for _, x, _ in data)
    
            summary = advice_urine(sex, alb_raw, sugar_raw, rbc_raw, wbc_raw)
            if is_all_urine_data_missing(urine_data):
                pass
            elif summary:
                st.markdown(f"""
                    <div style='
                        background-color: rgba(255, 215, 0, 0.2);
                        padding: 1rem;
                        border-radius: 6px;
                        margin-top: 1rem;
                        font-size: 16px;
                    '>
                        <b>üìå ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞ ‡∏õ‡∏µ {year_selected}:</b><br>{summary}
                    </div>
                """, unsafe_allow_html=True)
            else:
                st.success("‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°")

        # ==================== Stool Section ====================
            st.markdown(render_section_header("‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏∏‡∏à‡∏à‡∏≤‡∏£‡∏∞", "Stool Examination"), unsafe_allow_html=True)
        
            stool_exam_raw = person.get("Stool exam", "")
            stool_cs_raw = person.get("Stool C/S", "")
        
            def interpret_stool_exam(val):
                val = str(val or "").strip().lower()
                if val in ["", "-", "none", "nan"]:
                    return "-"
                elif val == "normal":
                    return "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß‡πÉ‡∏ô‡∏≠‡∏∏‡∏à‡∏à‡∏≤‡∏£‡∏∞ ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥"
                elif "wbc" in val or "‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß" in val:
                    return "‡∏û‡∏ö‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß‡πÉ‡∏ô‡∏≠‡∏∏‡∏à‡∏à‡∏≤‡∏£‡∏∞ ‡∏ô‡∏±‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏ã‡πâ‡∏≥"
                return val
        
            def interpret_stool_cs(value):
                value = str(value or "").strip()
                if value in ["", "-", "none", "nan"]:
                    return "-"
                if "‡πÑ‡∏°‡πà‡∏û‡∏ö" in value or "‡∏õ‡∏Å‡∏ï‡∏¥" in value:
                    return "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠"
                return "‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÉ‡∏ô‡∏≠‡∏∏‡∏à‡∏à‡∏≤‡∏£‡∏∞ ‡πÉ‡∏´‡πâ‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
        
            exam_text = interpret_stool_exam(stool_exam_raw)
            cs_text = interpret_stool_cs(stool_cs_raw)
        
            def render_stool_html_table(exam, cs):
                style = """
                <style>
                    .stool-container {
                        background-color: var(--background-color);
                        margin-top: 1rem;
                    }
                    .stool-table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 16px;
                        font-family: "Segoe UI", sans-serif;
                    }
                    .stool-table th {
                        background-color: var(--secondary-background-color);
                        color: var(--text-color);
                        padding: 8px 10px;
                        text-align: left;
                        font-weight: bold;
                        width: 40%;
                        border: 1px solid transparent;
                    }
                    .stool-table td {
                        padding: 8px 10px;
                        border: 1px solid transparent;  /* üëà ‡πÄ‡∏™‡πâ‡∏ô‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ï‡πà‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ */
                        color: var(--text-color);
                    }
                </style>
                """
                html = f"""
                <div class='stool-container'>
                    <table class='stool-table'>
                        <tr>
                            <th>‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏∏‡∏à‡∏à‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</th>
                            <td style='text-align: left;'>{exam if exam != "-" else "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à"}</td>
                        </tr>
                        <tr>
                            <th>‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏∏‡∏à‡∏à‡∏≤‡∏£‡∏∞‡πÄ‡∏û‡∏≤‡∏∞‡πÄ‡∏ä‡∏∑‡πâ‡∏≠</th>
                            <td style='text-align: left;'>{cs if cs != "-" else "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à"}</td>
                        </tr>
                    </table>
                </div>
                """
                return style + html
        
            st.markdown(render_stool_html_table(exam_text, cs_text), unsafe_allow_html=True)

    with col_ua_right:
        # ============ X-ray Section ============
        
        # ‚úÖ ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏ã‡πÄ‡∏£‡∏¢‡πå
        st.markdown(render_section_header("‡∏ú‡∏•‡πÄ‡∏≠‡∏Å‡∏ã‡πÄ‡∏£‡∏¢‡πå", "Chest X-ray"), unsafe_allow_html=True)
    
        # ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏ú‡∏•‡πÄ‡∏≠‡∏Å‡∏ã‡πÄ‡∏£‡∏¢‡πå
        def interpret_cxr(val):
            val = str(val or "").strip()
            if is_empty(val):
                return "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏Å‡∏ã‡πÄ‡∏£‡∏¢‡πå"
            if any(keyword in val.lower() for keyword in ["‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥", "‡∏ù‡πâ‡∏≤", "‡∏£‡∏≠‡∏¢", "abnormal", "infiltrate", "lesion"]):
                return f"{val} ‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
            return val
    
        # ‚úÖ ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå CXR ‡∏ï‡∏≤‡∏°‡∏õ‡∏µ
        selected_year_int = int(selected_year)
        cxr_col = "CXR" if selected_year_int == 2568 else f"CXR{str(selected_year_int)[-2:]}"
        cxr_raw = person.get(cxr_col, "")
        cxr_result = interpret_cxr(cxr_raw)
    
        # ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        st.markdown(f"""
        <div style='
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 16px;
            line-height: 1.6;
            padding: 1.25rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
        '>
            <b>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à:</b> {cxr_result}
        </div>
        """, unsafe_allow_html=True)

        # ==================== EKG Section ====================
        st.markdown(render_section_header("‡∏ú‡∏•‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏´‡∏±‡∏ß‡πÉ‡∏à", "EKG"), unsafe_allow_html=True)

        def get_ekg_col_name(year):
            return "EKG" if year == 2568 else f"EKG{str(year)[-2:]}"  # ‡πÄ‡∏ä‡πà‡∏ô EKG68, EKG67

        def interpret_ekg(val):
            val = str(val or "").strip()
            if is_empty(val):
                return "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏´‡∏±‡∏ß‡πÉ‡∏à"
            if any(x in val.lower() for x in ["‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥", "abnormal", "arrhythmia"]):
                return f"{val} ‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
            return val

        selected_year_int = int(selected_year)
        ekg_col = get_ekg_col_name(selected_year_int)
        ekg_raw = person.get(ekg_col, "")
        ekg_result = interpret_ekg(ekg_raw)

        st.markdown(f"""
        <div style='
            background-color: var(--secondary-background-color);
            color: var(--text-color);
            font-size: 16px;
            line-height: 1.6;
            padding: 1.25rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
        '>
            <b>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à:</b> {ekg_result}
        </div>
        """, unsafe_allow_html=True)

        # === Helper: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
        def safe_text(val):
            return "-" if str(val).strip().lower() in ["", "none", "nan", "-"] else str(val).strip()
        
        # === Section: Hepatitis A ===
        st.markdown(render_section_header("‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏ß‡∏£‡∏±‡∏™‡∏ï‡∏±‡∏ö‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö‡πÄ‡∏≠ (Viral hepatitis A)"), unsafe_allow_html=True)
        
        hep_a_raw = safe_text(person.get("Hepatitis A"))
        st.markdown(f"""
        <div style='
            font-size: 16px;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            background-color: rgba(255,255,255,0.05);
        '>
            {hep_a_raw}
        </div>
        """, unsafe_allow_html=True)
              
        # --- Extract extra info ---

        import re
        from datetime import datetime
        
        THAI_MONTHS = {
            "‡∏°.‡∏Ñ": 1, "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°": 1,
            "‡∏Å.‡∏û": 2, "‡∏Å‡∏û": 2, "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå": 2,
            "‡∏°‡∏µ.‡∏Ñ": 3, "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°": 3,
            "‡πÄ‡∏°.‡∏¢": 4, "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô": 4,
            "‡∏û.‡∏Ñ": 5, "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°": 5,
            "‡∏°‡∏¥.‡∏¢": 6, "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô": 6,
            "‡∏Å.‡∏Ñ": 7, "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°": 7,
            "‡∏™.‡∏Ñ": 8, "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°": 8,
            "‡∏Å.‡∏¢": 9, "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô": 9,
            "‡∏ï.‡∏Ñ": 10, "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°": 10,
            "‡∏û.‡∏¢": 11, "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô": 11,
            "‡∏ò.‡∏Ñ": 12, "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°": 12
        }
        
        def normalize_date(text):
            if not text or str(text).strip().lower() in ["-", "none", "null", "nan"]:
                return "-"
        
            text = str(text).strip()
        
            # ‡∏î‡∏∂‡∏á‡∏õ‡∏µ‡πÑ‡∏ó‡∏¢‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°
            year_match = re.search(r"\b(25\d{2})\b", text)
            if not year_match:
                # ‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏µ‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠ 2 ‡∏´‡∏•‡∏±‡∏Å
                year_match = re.search(r"\b(\d{2,4})\b", text)
        
            year = None
            if year_match:
                raw_year = int(year_match.group(1))
                if raw_year < 100:  # ‡∏õ‡∏µ‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠
                    year = raw_year + 2500 if raw_year < 80 else raw_year + 2400
                elif 1000 <= raw_year < 2100:
                    year = raw_year + 543  # ‡∏Ñ.‡∏®. ‚Üí ‡∏û.‡∏®.
                elif 2500 <= raw_year <= 2600:
                    year = raw_year
        
            # ‡∏´‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
            day_match = re.search(r"\b(\d{1,2})(?:[^\d]|$)", text)
            has_day = bool(day_match)
        
            # ‡∏´‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            month = None
            for name, num in THAI_MONTHS.items():
                if name in text:
                    month = num
                    break
        
            # ‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡∏õ‡∏µ ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡∏û.‡∏®. xxxx"
            if year and not has_day and not month:
                return f"‡∏û.‡∏®. {year}"
        
            # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°
            if year:
                day = int(day_match.group(1)) if has_day else 1
                month = month or 1
                try:
                    dt = datetime(year, month, day)
                    thai_month = [k for k, v in THAI_MONTHS.items() if v == month and len(k) > 3]
                    month_name = thai_month[0] if thai_month else "-"
                    return f"{dt.day} {month_name} {dt.year}"
                except:
                    return f"‡∏û.‡∏®. {year}"
        
            return "-"
    
        hep_check_date_raw = person.get("‡∏õ‡∏µ‡∏ï‡∏£‡∏ß‡∏àHEP")
        hep_check_date = normalize_date(hep_check_date_raw)
        
        hep_history = safe_text(person.get("‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Hepb"))
        hep_vaccine = safe_text(person.get("‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ôhep b 67"))
        
        # --- Render Section Header ---
        st.markdown(render_section_header("‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏ß‡∏£‡∏±‡∏™‡∏ï‡∏±‡∏ö‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö‡∏ö‡∏µ (Viral hepatitis B)"), unsafe_allow_html=True)
        
        # --- Extract Hepatitis Results ---
        hbsag_raw = safe_text(person.get("HbsAg"))
        hbsab_raw = safe_text(person.get("HbsAb"))
        hbcab_raw = safe_text(person.get("HBcAB"))
        
        # --- Show Table ---
        st.markdown(f"""
        <div style="margin-bottom: 1rem;">
        <table style='
            width: 100%;
            font-size: 16px;
            text-align: center;
            border-collapse: collapse;
            min-width: 300px;
        '>
            <thead>
                <tr>
                    <th style="padding: 8px; border: 1px solid transparent;">HBsAg</th>
                    <th style="padding: 8px; border: 1px solid transparent;">HBsAb</th>
                    <th style="padding: 8px; border: 1px solid transparent;">HBcAb</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="padding: 8px; border: 1px solid transparent;">{hbsag_raw}</td>
                    <td style="padding: 8px; border: 1px solid transparent;">{hbsab_raw}</td>
                    <td style="padding: 8px; border: 1px solid transparent;">{hbcab_raw}</td>
                </tr>
            </tbody>
        </table>
        </div>
        """, unsafe_allow_html=True)
        
        # --- Show extra info ---
        st.markdown(f"""
        <div style='
            font-size: 16px;
            padding: 0.75rem 1rem;
            background-color: rgba(255,255,255,0.05);
            border-radius: 6px;
            margin-bottom: 1.5rem;
            line-height: 1.8;
        '>
            <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏†‡∏π‡∏°‡∏¥‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô:</b> {hep_check_date}<br>
            <b>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÇ‡∏£‡∏Ñ‡πÑ‡∏ß‡∏£‡∏±‡∏™‡∏ï‡∏±‡∏ö‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö‡∏ö‡∏µ ‡∏õ‡∏µ ‡∏û.‡∏®. {year_selected}:</b> {hep_history}<br>
            <b>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô‡πÉ‡∏ô‡∏õ‡∏µ ‡∏û.‡∏®. {year_selected}:</b> {hep_vaccine}
        </div>
        """, unsafe_allow_html=True)
        
        # --- Advice ---
        def hepatitis_b_advice(hbsag, hbsab, hbcab):
            hbsag = hbsag.lower()
            hbsab = hbsab.lower()
            hbcab = hbcab.lower()
        
            if "positive" in hbsag:
                return "‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÑ‡∏ß‡∏£‡∏±‡∏™‡∏ï‡∏±‡∏ö‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö‡∏ö‡∏µ"
            elif "positive" in hbsab and "positive" not in hbsag:
                return "‡∏°‡∏µ‡∏†‡∏π‡∏°‡∏¥‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏ß‡∏£‡∏±‡∏™‡∏ï‡∏±‡∏ö‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö‡∏ö‡∏µ"
            elif "positive" in hbcab and "positive" not in hbsab:
                return "‡πÄ‡∏Ñ‡∏¢‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏π‡∏°‡∏¥‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"
            elif all(x == "negative" for x in [hbsag, hbsab, hbcab]):
                return "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏π‡∏°‡∏¥‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏ß‡∏£‡∏±‡∏™‡∏ï‡∏±‡∏ö‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö‡∏ö‡∏µ"
            return "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ã‡πâ‡∏≥"
        
        advice = hepatitis_b_advice(hbsag_raw, hbsab_raw, hbcab_raw)
        st.markdown(f"""
        <div style='
            font-size: 16px;
            padding: 1rem;
            border-radius: 6px;
            background-color: rgba(255, 215, 0, 0.15);
            margin-bottom: 1.5rem;
        '>
            <b>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</b> {advice}
        </div>
        """, unsafe_allow_html=True)
        
#=============== ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏û‡∏ó‡∏¢‡πå =======================
if "person_row" in st.session_state:
    person = st.session_state["person_row"]
    doctor_suggestion = str(person.get("DOCTER suggest", "")).strip()
    if doctor_suggestion.lower() in ["", "-", "none", "nan", "null"]:
        doctor_suggestion = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å‡πÅ‡∏û‡∏ó‡∏¢‡πå</i>"

    left_spacer3, doctor_col, right_spacer3 = st.columns([1, 6, 1])

    with doctor_col:
        st.markdown(f"""
        <div style='
            background-color: #1b5e20;
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 8px;
            font-size: 18px;
            line-height: 1.6;
            margin-top: 2rem;
            margin-bottom: 2rem;
            font-family: "Segoe UI", sans-serif;
        '>
            <b>‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå:</b><br> {doctor_suggestion}
        </div>

        <div style='
            margin-top: 7rem;
            text-align: right;
            padding-right: 1rem;
        '>
            <div style='
                display: inline-block;
                text-align: center;
                width: 340px;
            '>
                <div style='
                    border-bottom: 1px dotted #ccc;
                    margin-bottom: 0.5rem;
                    width: 100%;
                '></div>
                <div style='white-space: nowrap;'>‡∏ô‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ô‡∏û‡∏£‡∏±‡∏ï‡∏ô‡πå ‡∏£‡∏±‡∏ä‡∏é‡∏≤‡∏û‡∏£</div>
                <div style='white-space: nowrap;'>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û‡πÄ‡∏ß‡∏ä‡∏Å‡∏£‡∏£‡∏° ‡∏ß.26674</div>
            </div>
        </div>
        """, unsafe_allow_html=True)
