import streamlit as st
import sqlite3
import requests
import pandas as pd
import io
import tempfile
import html
import numpy as np
from collections import OrderedDict
from datetime import datetime
import re
import streamlit.components.v1 as components # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ component ‡∏Ç‡∏≠‡∏á streamlit ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á

# --- ALL HELPER FUNCTIONS (No Changes) ---
# ‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£
def is_empty(val):
    return str(val).strip().lower() in ["", "-", "none", "nan", "null"]
THAI_MONTHS_GLOBAL = {
    1: "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", 2: "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", 3: "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", 4: "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô",
    5: "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", 6: "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", 7: "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", 8: "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°",
    9: "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", 10: "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", 11: "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", 12: "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"
}
THAI_MONTH_ABBR_TO_NUM_GLOBAL = {
    "‡∏°.‡∏Ñ.": 1, "‡∏°.‡∏Ñ": 1, "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°": 1, "‡∏Å.‡∏û.": 2, "‡∏Å.‡∏û": 2, "‡∏Å‡∏û": 2, "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå": 2,
    "‡∏°‡∏µ.‡∏Ñ.": 3, "‡∏°‡∏µ.‡∏Ñ": 3, "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°": 3, "‡πÄ‡∏°.‡∏¢.": 4, "‡πÄ‡∏°.‡∏¢": 4, "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô": 4,
    "‡∏û.‡∏Ñ.": 5, "‡∏û.‡∏Ñ": 5, "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°": 5, "‡∏°‡∏¥.‡∏¢.": 6, "‡∏°‡∏¥.‡∏¢": 6, "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô": 6,
    "‡∏Å.‡∏Ñ.": 7, "‡∏Å.‡∏Ñ": 7, "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°": 7, "‡∏™.‡∏Ñ.": 8, "‡∏™.‡∏Ñ": 8, "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°": 8,
    "‡∏Å.‡∏¢.": 9, "‡∏Å.‡∏¢": 9, "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô": 9, "‡∏ï.‡∏Ñ.": 10, "‡∏ï.‡∏Ñ": 10, "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°": 10,
    "‡∏û.‡∏¢.": 11, "‡∏û.‡∏¢": 11, "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô": 11, "‡∏ò.‡∏Ñ.": 12, "‡∏ò.‡∏Ñ": 12, "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°": 12
}
def normalize_thai_date(date_str):
    if is_empty(date_str): return "-"
    s = str(date_str).strip().replace("‡∏û.‡∏®.", "").replace("‡∏û‡∏®.", "").strip()
    if s.lower() in ["‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏ß‡∏à", "‡∏ô‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏á", "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à", ""]: return s
    try:
        if re.match(r'^\d{1,2}/\d{1,2}/\d{4}$', s):
            day, month, year = map(int, s.split('/')); year -= 543 if year > 2500 else 0
            return f"{day} {THAI_MONTHS_GLOBAL[month]} {year + 543}"
        if re.match(r'^\d{1,2}-\d{1,2}-\d{4}$', s):
            day, month, year = map(int, s.split('-')); year -= 543 if year > 2500 else 0
            return f"{day} {THAI_MONTHS_GLOBAL[month]} {year + 543}"
        match = re.match(r'^(?P<day1>\d{1,2})(?:-\d{1,2})?\s*(?P<month_str>[‡∏Å-‡∏Æ]+\.?)\s*(?P<year>\d{4})$', s)
        if match:
            day, month_str, year = int(match.group('day1')), match.group('month_str').strip('.'), int(match.group('year'))
            month_num = THAI_MONTH_ABBR_TO_NUM_GLOBAL.get(month_str)
            if month_num: return f"{day} {THAI_MONTHS_GLOBAL[month_num]} {year}"
    except: pass
    try:
        dt = pd.to_datetime(s, dayfirst=True, errors='coerce')
        if pd.notna(dt):
            year = dt.year - 543 if dt.year > datetime.now().year + 50 else dt.year
            return f"{dt.day} {THAI_MONTHS_GLOBAL[dt.month]} {year + 543}"
    except: pass
    return str(date_str)
def get_float(col, person_data):
    try:
        val = person_data.get(col, "")
        if is_empty(val): return None
        return float(str(val).replace(",", "").strip())
    except: return None
def flag(val, low=None, high=None, higher_is_better=False):
    try:
        val = float(str(val).replace(",", "").strip())
    except: return "-", False
    if higher_is_better and low is not None: return f"{val:.1f}", val < low
    if low is not None and val < low: return f"{val:.1f}", True
    if high is not None and val > high: return f"{val:.1f}", True
    return f"{val:.1f}", False
def render_section_header(title, subtitle=None):
    full_title = f"{title} <span style='font-weight: normal;'>({subtitle})</span>" if subtitle else title
    return f"""<div style='background-color: #1b5e20; color: white; text-align: center; padding: 0.8rem 0.5rem; font-weight: bold; border-radius: 8px; margin-top: 2rem; margin-bottom: 1rem; font-size: 14px;'>{full_title}</div>"""
def render_lab_table_html(title, subtitle, headers, rows, table_class="lab-table"):
    style = f"""<style>
        .{table_class}-container {{ margin-top: 1rem; }}
        .{table_class} {{ width: 100%; border-collapse: collapse; color: var(--text-color); table-layout: fixed; font-size: 14px; }}
        .{table_class} thead th {{ background-color: var(--secondary-background-color); color: var(--text-color); padding: 2px 2px; text-align: center; font-weight: bold; border: 1px solid transparent; }}
        .{table_class} td {{ padding: 2px 2px; border: 1px solid transparent; text-align: center; color: var(--text-color); }}
        .{table_class}-abn {{ background-color: rgba(255, 64, 64, 0.25); }}
        .{table_class}-row {{ background-color: rgba(255,255,255,0.02); }}
    </style>"""
    header_html = render_section_header(title, subtitle)
    html_content = f"{style}{header_html}<div class='{table_class}-container'><table class='{table_class}'>"
    html_content += """<colgroup><col style="width: 33.33%;"><col style="width: 33.33%;"><col style="width: 33.33%;"></colgroup>"""
    html_content += "<thead><tr>"
    for i, h in enumerate(headers):
        align = "left" if i == 0 or i == 2 else "center"
        html_content += f"<th style='text-align: {align};'>{h}</th>"
    html_content += "</tr></thead><tbody>"
    for row in rows:
        is_abn = any(flag for _, flag in row)
        row_class = f"{table_class}-abn" if is_abn else f"{table_class}-row"
        html_content += "<tr>"
        html_content += f"<td class='{row_class}' style='text-align: left;'>{row[0][0]}</td>"
        html_content += f"<td class='{row_class}'>{row[1][0]}</td>"
        html_content += f"<td class='{row_class}' style='text-align: left;'>{row[2][0]}</td>"
        html_content += "</tr>"
    html_content += "</tbody></table></div>"
    return html_content
def kidney_summary_gfr_only(gfr_raw):
    try:
        gfr = float(str(gfr_raw).replace(",", "").strip())
        if gfr == 0: return ""
        elif gfr < 60: return "‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÑ‡∏ï‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"
        else: return "‡∏õ‡∏Å‡∏ï‡∏¥"
    except: return ""
def kidney_advice_from_summary(summary_text):
    if summary_text == "‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÑ‡∏ï‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢":
        return "‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÑ‡∏ï‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡∏•‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏Ñ‡πá‡∏° ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡∏™‡∏π‡∏á‡∏¢‡πà‡∏≠‡∏¢‡∏¢‡∏≤‡∏Å ‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥ 8-10 ‡πÅ‡∏Å‡πâ‡∏ß‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏Å‡∏•‡∏±‡πâ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞ ‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ö‡∏ß‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå"
    return ""
def fbs_advice(fbs_raw):
    if is_empty(fbs_raw): return ""
    try:
        value = float(str(fbs_raw).replace(",", "").strip())
        if value == 0: return ""
        elif 100 <= value < 106: return "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏ß‡∏≤‡∏ô ‡πÅ‡∏õ‡πâ‡∏á ‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢"
        elif 106 <= value < 126: return "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏ß‡∏≤‡∏ô ‡πÅ‡∏õ‡πâ‡∏á ‡∏Ç‡∏≠‡∏á‡∏°‡∏±‡∏ô ‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏ã‡πâ‡∏≥ ‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠"
        elif value >= 126: return "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡∏™‡∏π‡∏á ‡∏Ñ‡∏ß‡∏£‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£"
        else: return ""
    except: return ""
def summarize_liver(alp_val, sgot_val, sgpt_val):
    try:
        alp, sgot, sgpt = float(alp_val), float(sgot_val), float(sgpt_val)
        if alp == 0 or sgot == 0 or sgpt == 0: return "-"
        if alp > 120 or sgot > 36 or sgpt > 40: return "‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"
        return "‡∏õ‡∏Å‡∏ï‡∏¥"
    except: return ""
def liver_advice(summary_text):
    if summary_text == "‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢": return "‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏™‡∏π‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ö‡∏ã‡πâ‡∏≥"
    return "" if summary_text == "‡∏õ‡∏Å‡∏ï‡∏¥" else "-"
def uric_acid_advice(value_raw):
    try:
        value = float(value_raw)
        if value > 7.2: return "‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏ß‡∏£‡∏µ‡∏ô‡∏™‡∏π‡∏á ‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ô‡∏™‡∏±‡∏ï‡∏ß‡πå ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏∞‡πÄ‡∏• ‡πÅ‡∏•‡∏∞‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î‡∏Ç‡πâ‡∏≠"
        return ""
    except: return "-"
def summarize_lipids(chol_raw, tgl_raw, ldl_raw):
    try:
        chol, tgl, ldl = float(str(chol_raw).replace(",", "").strip()), float(str(tgl_raw).replace(",", "").strip()), float(str(ldl_raw).replace(",", "").strip())
        if chol == 0 and tgl == 0: return ""
        if chol >= 250 or tgl >= 250 or ldl >= 180: return "‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á"
        elif chol <= 200 and tgl <= 150: return "‡∏õ‡∏Å‡∏ï‡∏¥"
        else: return "‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"
    except: return ""
def lipids_advice(summary_text):
    if summary_text == "‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á": return "‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á ‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏≠‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≠‡∏á‡∏ó‡∏≠‡∏î ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠ ‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°"
    elif summary_text == "‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢": return "‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ ‡∏•‡∏î‡∏Ç‡∏≠‡∏á‡∏°‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏Ç‡∏°‡∏±‡∏ô"
    return ""
def cbc_advice(hb, hct, wbc, plt, sex="‡∏ä‡∏≤‡∏¢"):
    advice_parts = []
    try:
        hb_val, hb_ref = float(hb), 13 if sex == "‡∏ä‡∏≤‡∏¢" else 12
        if hb_val < hb_ref: advice_parts.append("‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Æ‡∏µ‡πÇ‡∏°‡πÇ‡∏Å‡∏•‡∏ö‡∏¥‡∏ô‡∏ï‡πà‡∏≥ ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡∏†‡∏≤‡∏ß‡∏∞‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏à‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ã‡πâ‡∏≥")
    except: pass
    try:
        hct_val, hct_ref = float(hct), 39 if sex == "‡∏ä‡∏≤‡∏¢" else 36
        if hct_val < hct_ref: advice_parts.append("‡∏Ñ‡πà‡∏≤‡∏Æ‡∏µ‡∏°‡∏≤‡πÇ‡∏ï‡∏Ñ‡∏£‡∏¥‡∏ï‡∏ï‡πà‡∏≥ ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡∏†‡∏≤‡∏ß‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏à‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°")
    except: pass
    try:
        wbc_val = float(wbc)
        if wbc_val < 4000: advice_parts.append("‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß‡∏ï‡πà‡∏≥ ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏†‡∏π‡∏°‡∏¥‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô‡∏•‡∏î ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°")
        elif wbc_val > 10000: advice_parts.append("‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß‡∏™‡∏π‡∏á ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö ‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏Ñ‡∏ß‡∏£‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå")
    except: pass
    try:
        plt_val = float(plt)
        if plt_val < 150000: advice_parts.append("‡πÄ‡∏Å‡∏•‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ï‡πà‡∏≥ ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏†‡∏≤‡∏ß‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å‡∏á‡πà‡∏≤‡∏¢ ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ã‡πâ‡∏≥")
        elif plt_val > 500000: advice_parts.append("‡πÄ‡∏Å‡∏•‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏™‡∏π‡∏á ‡∏Ñ‡∏ß‡∏£‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°")
    except: pass
    return " ".join(advice_parts)
def interpret_bp(sbp, dbp):
    try:
        sbp, dbp = float(sbp), float(dbp)
        if sbp == 0 or dbp == 0: return "-"
        if sbp >= 160 or dbp >= 100: return "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á"
        elif sbp >= 140 or dbp >= 90: return "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"
        elif sbp < 120 and dbp < 80: return "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥"
        else: return "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏™‡∏π‡∏á"
    except: return "-"
def combined_health_advice(bmi, sbp, dbp):
    if is_empty(bmi) and is_empty(sbp) and is_empty(dbp): return ""
    try: bmi = float(bmi)
    except: bmi = None
    try: sbp, dbp = float(sbp), float(dbp)
    except: sbp = dbp = None
    bmi_text, bp_text = "", ""
    if bmi is not None:
        if bmi > 30: bmi_text = "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏°‡∏≤‡∏Å"
        elif bmi >= 25: bmi_text = "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô"
        elif bmi < 18.5: bmi_text = "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô"
        else: bmi_text = "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥"
    if sbp is not None and dbp is not None:
        if sbp >= 160 or dbp >= 100: bp_text = "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å"
        elif sbp >= 140 or dbp >= 90: bp_text = "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á"
        elif sbp >= 120 or dbp >= 80: bp_text = "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏π‡∏á"
    if bmi is not None and "‡∏õ‡∏Å‡∏ï‡∏¥" in bmi_text and not bp_text: return "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏î‡∏µ ‡∏Ñ‡∏ß‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡πÑ‡∏õ"
    if not bmi_text and bp_text: return f"{bp_text} ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠"
    if bmi_text and bp_text: return f"{bmi_text} ‡πÅ‡∏•‡∏∞ {bp_text} ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢"
    if bmi_text and not bp_text: return f"{bmi_text} ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°"
    return ""
def safe_text(val): return "-" if str(val).strip().lower() in ["", "none", "nan", "-"] else str(val).strip()
def safe_value(val): return "-" if str(val or "").strip().lower() in ["", "nan", "none", "-"] else str(val or "").strip()
def interpret_alb(value):
    val = str(value).strip().lower()
    if val == "negative": return "‡πÑ‡∏°‡πà‡∏û‡∏ö"
    elif val in ["trace", "1+", "2+"]: return "‡∏û‡∏ö‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"
    elif val in ["3+", "4+"]: return "‡∏û‡∏ö‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞"
    return "-"
def interpret_sugar(value):
    val = str(value).strip().lower()
    if val == "negative": return "‡πÑ‡∏°‡πà‡∏û‡∏ö"
    elif val == "trace": return "‡∏û‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"
    elif val in ["1+", "2+", "3+", "4+", "5+", "6+"]: return "‡∏û‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞"
    return "-"
def parse_range_or_number(val):
    val = val.replace("cell/hpf", "").replace("cells/hpf", "").replace("cell", "").strip().lower()
    try:
        if "-" in val: low, high = map(float, val.split("-")); return low, high
        else: num = float(val); return num, num
    except: return None, None
def interpret_rbc(value):
    val = str(value or "").strip().lower()
    if val in ["-", "", "none", "nan"]: return "-"
    low, high = parse_range_or_number(val)
    if high is None: return value
    if high <= 2: return "‡∏õ‡∏Å‡∏ï‡∏¥"
    elif high <= 5: return "‡∏û‡∏ö‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÅ‡∏î‡∏á‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"
    else: return "‡∏û‡∏ö‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÅ‡∏î‡∏á‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞"
def interpret_wbc(value):
    val = str(value or "").strip().lower()
    if val in ["-", "", "none", "nan"]: return "-"
    low, high = parse_range_or_number(val)
    if high is None: return value
    if high <= 5: return "‡∏õ‡∏Å‡∏ï‡∏¥"
    elif high <= 10: return "‡∏û‡∏ö‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"
    else: return "‡∏û‡∏ö‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞"
def advice_urine(sex, alb, sugar, rbc, wbc):
    alb_t, sugar_t, rbc_t, wbc_t = interpret_alb(alb), interpret_sugar(sugar), interpret_rbc(rbc), interpret_wbc(wbc)
    if all(x in ["-", "‡∏õ‡∏Å‡∏ï‡∏¥", "‡πÑ‡∏°‡πà‡∏û‡∏ö", "‡∏û‡∏ö‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢", "‡∏û‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢"] for x in [alb_t, sugar_t, rbc_t, wbc_t]): return ""
    if "‡∏û‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞" in sugar_t and "‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢" not in sugar_t: return "‡∏Ñ‡∏ß‡∏£‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡πÇ‡∏†‡∏Ñ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
    if sex == "‡∏´‡∏ç‡∏¥‡∏á" and "‡∏û‡∏ö‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÅ‡∏î‡∏á" in rbc_t and "‡∏õ‡∏Å‡∏ï‡∏¥" in wbc_t: return "‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏õ‡∏ô‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ã‡πâ‡∏≥"
    if sex == "‡∏ä‡∏≤‡∏¢" and "‡∏û‡∏ö‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÅ‡∏î‡∏á" in rbc_t and "‡∏õ‡∏Å‡∏ï‡∏¥" in wbc_t: return "‡∏û‡∏ö‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÅ‡∏î‡∏á‡πÉ‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞ ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
    if "‡∏û‡∏ö‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß" in wbc_t and "‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢" not in wbc_t: return "‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ã‡πâ‡∏≥"
    return "‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡∏ã‡πâ‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•"
def is_urine_abnormal(test_name, value, normal_range):
    val = str(value or "").strip().lower()
    if val in ["", "-", "none", "nan", "null"]: return False
    if test_name == "‡∏Å‡∏£‡∏î-‡∏î‡πà‡∏≤‡∏á (pH)":
        try: return not (5.0 <= float(val) <= 8.0)
        except: return True
    if test_name == "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡πà‡∏ß‡∏á‡∏à‡∏≥‡πÄ‡∏û‡∏≤‡∏∞ (Sp.gr)":
        try: return not (1.003 <= float(val) <= 1.030)
        except: return True
    if test_name == "‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÅ‡∏î‡∏á (RBC)": return "‡∏û‡∏ö" in interpret_rbc(val).lower()
    if test_name == "‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß (WBC)": return "‡∏û‡∏ö" in interpret_wbc(val).lower()
    if test_name == "‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• (Sugar)": return interpret_sugar(val).lower() != "‡πÑ‡∏°‡πà‡∏û‡∏ö"
    if test_name == "‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô (Albumin)": return interpret_alb(val).lower() != "‡πÑ‡∏°‡πà‡∏û‡∏ö"
    if test_name == "‡∏™‡∏µ (Colour)": return val not in ["yellow", "pale yellow", "colorless", "paleyellow", "light yellow"]
    return False
def render_urine_section(person_data, sex, year_selected):
    urine_data = [("‡∏™‡∏µ (Colour)", person_data.get("Color", "-"), "Yellow, Pale Yellow"),("‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• (Sugar)", person_data.get("sugar", "-"), "Negative"),("‡πÇ‡∏õ‡∏£‡∏ï‡∏µ‡∏ô (Albumin)", person_data.get("Alb", "-"), "Negative, trace"),("‡∏Å‡∏£‡∏î-‡∏î‡πà‡∏≤‡∏á (pH)", person_data.get("pH", "-"), "5.0 - 8.0"),("‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡πà‡∏ß‡∏á‡∏à‡∏≥‡πÄ‡∏û‡∏≤‡∏∞ (Sp.gr)", person_data.get("Spgr", "-"), "1.003 - 1.030"),("‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÅ‡∏î‡∏á (RBC)", person_data.get("RBC1", "-"), "0 - 2 cell/HPF"),("‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß (WBC)", person_data.get("WBC1", "-"), "0 - 5 cell/HPF"),("‡πÄ‡∏ã‡∏•‡∏•‡πå‡πÄ‡∏¢‡∏∑‡πà‡∏≠‡∏ö‡∏∏‡∏ú‡∏¥‡∏ß (Squam.epit.)", person_data.get("SQ-epi", "-"), "0 - 10 cell/HPF"),("‡∏≠‡∏∑‡πà‡∏ô‡πÜ", person_data.get("ORTER", "-"), "-"),]
    df_urine = pd.DataFrame(urine_data, columns=["‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à", "‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à", "‡∏Ñ‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥"])
    html_content = render_section_header("‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞", "Urinalysis") + "<div class='urine-table-container'><table class='urine-table' style='font-size:14px;width:100%;border-collapse:collapse;table-layout:fixed;'><colgroup><col style='width:33.33%;'><col style='width:33.33%;'><col style='width:33.33%;'></colgroup><thead><tr><th style='text-align:left;'>‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</th><th>‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à</th><th style='text-align:left;'>‡∏Ñ‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥</th></tr></thead><tbody>"
    for _, row in df_urine.iterrows():
        is_abn = is_urine_abnormal(row["‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à"], row["‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à"], row["‡∏Ñ‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥"])
        css_class = "urine-abn" if is_abn else "urine-row"
        html_content += f"<tr class='{css_class}'><td style='text-align:left;'>{row['‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à']}</td><td>{safe_value(row['‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à'])}</td><td style='text-align:left;'>{row['‡∏Ñ‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥']}</td></tr>"
    html_content += "</tbody></table></div>"
    st.markdown(html_content, unsafe_allow_html=True)
    summary = advice_urine(sex, person_data.get("Alb", "-"), person_data.get("sugar", "-"), person_data.get("RBC1", "-"), person_data.get("WBC1", "-"))
    if any(not is_empty(val) for _, val, _ in urine_data):
        if summary: st.markdown(f"<div style='background-color:rgba(255,255,0,0.2);color:var(--text-color);padding:1rem;border-radius:6px;margin-top:1rem;font-size:14px;'>{summary}</div>", unsafe_allow_html=True)
        else: st.markdown("<div style='background-color:rgba(57,255,20,0.2);color:var(--text-color);padding:1rem;border-radius:6px;margin-top:1rem;font-size:14px;'>‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥</div>", unsafe_allow_html=True)
def interpret_stool_exam(val):
    val = str(val or "").strip().lower()
    if val in ["", "-", "none", "nan"]: return "-"
    elif val == "normal": return "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß‡πÉ‡∏ô‡∏≠‡∏∏‡∏à‡∏à‡∏≤‡∏£‡∏∞ ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥"
    elif "wbc" in val or "‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß" in val: return "‡∏û‡∏ö‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß‡πÉ‡∏ô‡∏≠‡∏∏‡∏à‡∏à‡∏≤‡∏£‡∏∞ ‡∏ô‡∏±‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏ã‡πâ‡∏≥"
    return val
def interpret_stool_cs(value):
    value = str(value or "").strip()
    if value in ["", "-", "none", "nan"]: return "-"
    if "‡πÑ‡∏°‡πà‡∏û‡∏ö" in value or "‡∏õ‡∏Å‡∏ï‡∏¥" in value: return "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠"
    return "‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÉ‡∏ô‡∏≠‡∏∏‡∏à‡∏à‡∏≤‡∏£‡∏∞ ‡πÉ‡∏´‡πâ‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
def render_stool_html_table(exam, cs):
    html = "<div class='stool-container' style='margin-top:1rem;'><table class='stool-table' style='width:100%;border-collapse:collapse;table-layout:fixed;font-size:14px;'><colgroup><col style='width:50%;'><col style='width:50%;'></colgroup>"
    html += f"<tr><th style='text-align:left;width:50%;'>‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏∏‡∏à‡∏à‡∏≤‡∏£‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</th><td style='text-align:left;'>{exam if exam != '-' else '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à'}</td></tr>"
    html += f"<tr><th style='text-align:left;width:50%;'>‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏∏‡∏à‡∏à‡∏≤‡∏£‡∏∞‡πÄ‡∏û‡∏≤‡∏∞‡πÄ‡∏ä‡∏∑‡πâ‡∏≠</th><td style='text-align:left;'>{cs if cs != '-' else '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à'}</td></tr>"
    html += "</table></div>"
    return html
def interpret_cxr(val):
    val = str(val or "").strip()
    if is_empty(val): return "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏≠‡∏Å‡∏ã‡πÄ‡∏£‡∏¢‡πå"
    if any(k in val.lower() for k in ["‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥", "‡∏ù‡πâ‡∏≤", "‡∏£‡∏≠‡∏¢", "abnormal", "infiltrate", "lesion"]): return f"{val} ‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
    return val
def get_ekg_col_name(year):
    return "EKG" if year == datetime.now().year + 543 else f"EKG{str(year)[-2:]}"
def interpret_ekg(val):
    val = str(val or "").strip()
    if is_empty(val): return "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏´‡∏±‡∏ß‡πÉ‡∏à"
    if any(x in val.lower() for x in ["‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥", "abnormal", "arrhythmia"]): return f"{val} ‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
    return val
def hepatitis_b_advice(hbsag, hbsab, hbcab):
    hbsag, hbsab, hbcab = hbsag.lower(), hbsab.lower(), hbcab.lower()
    if "positive" in hbsag: return "‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÑ‡∏ß‡∏£‡∏±‡∏™‡∏ï‡∏±‡∏ö‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö‡∏ö‡∏µ"
    elif "positive" in hbsab and "positive" not in hbsag: return "‡∏°‡∏µ‡∏†‡∏π‡∏°‡∏¥‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏ß‡∏£‡∏±‡∏™‡∏ï‡∏±‡∏ö‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö‡∏ö‡∏µ"
    elif "positive" in hbcab and "positive" not in hbsab: return "‡πÄ‡∏Ñ‡∏¢‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏π‡∏°‡∏¥‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô"
    elif all(x == "negative" for x in [hbsag, hbsab, hbcab]): return "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏π‡∏°‡∏¥‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏ß‡∏£‡∏±‡∏™‡∏ï‡∏±‡∏ö‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö‡∏ö‡∏µ ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô"
    return "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ã‡πâ‡∏≥"
def merge_final_advice_grouped(messages):
    groups = {"FBS": [], "‡πÑ‡∏ï": [], "‡∏ï‡∏±‡∏ö": [], "‡∏¢‡∏π‡∏£‡∏¥‡∏Ñ": [], "‡πÑ‡∏Ç‡∏°‡∏±‡∏ô": [], "‡∏≠‡∏∑‡πà‡∏ô‡πÜ": []}
    for msg in messages:
        if not msg or msg.strip() in ["-", ""]: continue
        if "‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•" in msg: groups["FBS"].append(msg)
        elif "‡πÑ‡∏ï" in msg: groups["‡πÑ‡∏ï"].append(msg)
        elif "‡∏ï‡∏±‡∏ö" in msg: groups["‡∏ï‡∏±‡∏ö"].append(msg)
        elif "‡∏û‡∏¥‡∏ß‡∏£‡∏µ‡∏ô" in msg or "‡∏¢‡∏π‡∏£‡∏¥‡∏Ñ" in msg: groups["‡∏¢‡∏π‡∏£‡∏¥‡∏Ñ"].append(msg)
        elif "‡πÑ‡∏Ç‡∏°‡∏±‡∏ô" in msg: groups["‡πÑ‡∏Ç‡∏°‡∏±‡∏ô"].append(msg)
        else: groups["‡∏≠‡∏∑‡πà‡∏ô‡πÜ"].append(msg)
    output = [f"<b>{title}:</b> {' '.join(list(OrderedDict.fromkeys(msgs)))}" for title, msgs in groups.items() if msgs]
    if not output: return "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à"
    return "<div style='margin-bottom:0.75rem;'>" + "</div><div style='margin-bottom:0.75rem;'>".join(output) + "</div>"

# --- Data Loading ---
@st.cache_data(ttl=600)
def load_sqlite_data():
    try:
        file_id = "1HruO9AMrUfniC8hBWtumVdxLJayEc1Xr"
        download_url = f"https://drive.google.com/uc?export=download&id={file_id}"
        response = requests.get(download_url)
        response.raise_for_status()
        with tempfile.NamedTemporaryFile(delete=False, suffix=".db") as tmp:
            tmp.write(response.content)
            tmp_path = tmp.name
        conn = sqlite3.connect(tmp_path)
        df_loaded = pd.read_sql("SELECT * FROM health_data", conn)
        conn.close()
        df_loaded.columns = df_loaded.columns.str.strip()
        df_loaded['HN'] = df_loaded['HN'].apply(lambda x: str(int(x)) if pd.notna(x) and isinstance(x, (float, int)) else str(x)).str.strip()
        df_loaded['‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•'] = df_loaded['‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•'].astype(str).str.strip()
        df_loaded['Year'] = pd.to_numeric(df_loaded['Year'], errors='coerce').astype('Int64')
        df_loaded['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à'] = df_loaded['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à'].apply(normalize_thai_date)
        df_loaded.replace(["-", "None", None, np.nan], pd.NA, inplace=True)
        return df_loaded
    except Exception as e:
        st.error(f"‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {e}")
        st.stop()

# --- Main App ---
df = load_sqlite_data()
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û", layout="wide")

# --- CSS Injection (FIXED for FONT and PRINT) ---
st.markdown("""
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap');
    
    /* 1. Force Sarabun on ALL elements */
    * {
        font-family: 'Sarabun', sans-serif !important;
    }
    
    /* 2. Create a specific exception for the sidebar collapse button icon */
    [data-testid="stSidebarNavCollapseButton"] * {
        font-family: 'sans-serif' !important; /* Revert to a generic font for the icon */
    }

    @media print {
        .no-print { display: none !important; }
        [data-testid="stSidebar"] { display: none !important; }
        section[data-testid="stAppViewContainer"] { left: 0 !important; width: 100% !important; padding: 1rem !important; }
    }
    </style>
""", unsafe_allow_html=True)

# --- Callback Function ---
def update_report_view():
    try:
        results_df = st.session_state["search_result"]
        year = st.session_state.year_select_sidebar
        date = st.session_state.exam_date_select_sidebar
        row_df = results_df[(results_df['Year'] == year) & (results_df['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à'] == date)]
        if not row_df.empty:
            st.session_state.person_row = row_df.iloc[0].to_dict()
    except (KeyError, IndexError):
        st.session_state.pop("person_row", None)

# --- Sidebar ---
with st.sidebar:
    st.markdown("<h3>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h3>", unsafe_allow_html=True)
    st.text_input("‡∏Å‡∏£‡∏≠‡∏Å HN ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•", key="search_input_val")

    if st.button("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤", use_container_width=True):
        search_term = st.session_state.get("search_input_val", "").strip()
        for key in list(st.session_state.keys()):
            if key != 'search_input_val': del st.session_state[key]
        if search_term:
            query_df = df[df["HN"].str.contains(search_term, na=False) | df["‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•"].str.contains(search_term, na=False)]
            if query_df.empty:
                st.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•")
            else:
                st.session_state.search_result = query_df.reset_index(drop=True)
                latest_record = st.session_state.search_result.sort_values(by="Year", ascending=False).iloc[0]
                st.session_state.person_row = latest_record.to_dict()
                st.session_state.year_select_sidebar = latest_record["Year"]
                st.session_state.exam_date_select_sidebar = latest_record["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à"]
        else:
            st.info("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤")

    if "search_result" in st.session_state:
        results_df = st.session_state["search_result"]
        st.markdown("<hr>", unsafe_allow_html=True)
        st.markdown("<h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à</h3>", unsafe_allow_html=True)

        available_years = sorted(results_df["Year"].dropna().unique().astype(int), reverse=True)
        year_index = available_years.index(st.session_state.year_select_sidebar) if st.session_state.get("year_select_sidebar") in available_years else 0
        st.selectbox("üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à", available_years, index=year_index, key="year_select_sidebar", format_func=lambda y: f"‡∏û.‡∏®. {y}", on_change=update_report_view)

        current_year = st.session_state.get("year_select_sidebar", available_years[0])
        person_year_df = results_df[results_df["Year"] == current_year]
        exam_dates_options = sorted(person_year_df["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à"].dropna().unique(), key=lambda d: pd.to_datetime(d, dayfirst=True, errors='coerce'), reverse=True)
        
        if exam_dates_options:
            date_index = exam_dates_options.index(st.session_state.exam_date_select_sidebar) if st.session_state.get("exam_date_select_sidebar") in exam_dates_options else 0
            st.selectbox("üóìÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à", exam_dates_options, index=date_index, key="exam_date_select_sidebar", on_change=update_report_view)
        
        st.markdown("---")
        # --- FIXED PRINT BUTTON ---
        print_button_html = """
        <style>
            .print-button {
                display: inline-flex; align-items: center; justify-content: center;
                font-weight: 400; padding: 0.25rem 0.75rem; border-radius: 0.5rem;
                min-height: 38.4px; margin: 0px; line-height: 1.6;
                color: inherit; width: 100%; user-select: none;
                background-color: var(--secondary-background-color);
                border: 1px solid rgba(49, 51, 63, 0.2);
                cursor: pointer;
            }
            .print-button:hover {
                border-color: var(--primary-color);
                color: var(--primary-color);
            }
            .print-button:active {
                background-color: var(--primary-color);
                color: white;
            }
        </style>
        <button class="print-button" onclick="window.print()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</button>
        """
        components.html(print_button_html, height=50)

# ==================== Display Health Report (Main Content) ====================
if "person_row" in st.session_state:
    person = st.session_state["person_row"]
    year_display = person.get("Year", "-")
    sbp = person.get("SBP", "")
    dbp = person.get("DBP", "")
    pulse_raw = person.get("pulse", "-")
    weight_raw = person.get("‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å", "-")
    height_raw = person.get("‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á", "-")
    waist_raw = person.get("‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß", "-")
    check_date = person.get("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à", "-")

    report_header_html = f"""<div class="report-header-container" style="text-align: center; margin-bottom: 0.5rem;"><h1>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h1><h2>- ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡πÄ‡∏ß‡∏ä‡∏Å‡∏£‡∏£‡∏° -</h2><p>‡∏ä‡∏±‡πâ‡∏ô 2 ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å-‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏ ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ 201 ‡∏´‡∏°‡∏π‡πà 11 ‡∏ñ.‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‚Äì‡∏û‡∏£‡πâ‡∏≤‡∏ß ‡∏ï.‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏≤‡∏£ ‡∏≠.‡∏™‡∏±‡∏ô‡∏ó‡∏£‡∏≤‡∏¢ ‡∏à.‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà 50290</p><p>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏ß‡πÄ‡∏ß‡∏ä‡∏Å‡∏£‡∏£‡∏° ‡πÇ‡∏ó‡∏£ 053 921 199 ‡∏ï‡πà‡∏≠ 167</p><p><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à:</b> {check_date or "-"}</p></div>"""
    st.markdown(report_header_html, unsafe_allow_html=True)
    
    try:
        weight_val = float(str(weight_raw).replace("‡∏Å‡∏Å.", "").strip())
        height_val = float(str(height_raw).replace("‡∏ã‡∏°.", "").strip())
        bmi_val = weight_val / ((height_val / 100) ** 2) if height_val > 0 else None
    except: bmi_val = None
    try:
        sbp_int, dbp_int = int(float(sbp)), int(float(dbp))
        bp_val = f"{sbp_int}/{dbp_int} ‡∏°.‡∏°.‡∏õ‡∏£‡∏≠‡∏ó"
        bp_desc = interpret_bp(sbp, dbp)
        bp_full = f"{bp_val} - {bp_desc}" if bp_desc != "-" else bp_val
    except: bp_full = "-"
    try: pulse = f"{int(float(pulse_raw))} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ô‡∏≤‡∏ó‡∏µ"
    except: pulse = "-"
    weight_display = f"{weight_raw} ‡∏Å‡∏Å." if not is_empty(weight_raw) else "-"
    height_display = f"{height_raw} ‡∏ã‡∏°." if not is_empty(height_raw) else "-"
    waist_display = f"{waist_raw} ‡∏ã‡∏°." if not is_empty(waist_raw) else "-"
    summary_advice = html.escape(combined_health_advice(bmi_val, sbp, dbp) or "")
    
    st.markdown(f"""<div><hr><div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 32px; margin-top: 24px; margin-bottom: 20px; text-align: center;"><div><b>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</b> {person.get('‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•', '-')}</div><div><b>‡∏≠‡∏≤‡∏¢‡∏∏:</b> {str(int(float(person.get('‡∏≠‡∏≤‡∏¢‡∏∏')))) if str(person.get('‡∏≠‡∏≤‡∏¢‡∏∏')).replace('.', '', 1).isdigit() else person.get('‡∏≠‡∏≤‡∏¢‡∏∏', '-')} ‡∏õ‡∏µ</div><div><b>‡πÄ‡∏û‡∏®:</b> {person.get('‡πÄ‡∏û‡∏®', '-')}</div><div><b>HN:</b> {str(int(float(person.get('HN')))) if str(person.get('HN')).replace('.', '', 1).isdigit() else person.get('HN', '-')}</div><div><b>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</b> {person.get('‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô', '-')}</div></div><div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 32px; margin-bottom: 16px; text-align: center;"><div><b>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å:</b> {weight_display}</div><div><b>‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á:</b> {height_display}</div><div><b>‡∏£‡∏≠‡∏ö‡πÄ‡∏≠‡∏ß:</b> {waist_display}</div><div><b>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï:</b> {bp_full}</div><div><b>‡∏ä‡∏µ‡∏û‡∏à‡∏£:</b> {pulse}</div></div>{f"<div style='margin-top: 16px; text-align: center;'><b>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</b> {summary_advice}</div>" if summary_advice else ""}</div>""", unsafe_allow_html=True)

    sex = str(person.get("‡πÄ‡∏û‡∏®", "")).strip()
    if sex not in ["‡∏ä‡∏≤‡∏¢", "‡∏´‡∏ç‡∏¥‡∏á"]: sex = "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"
    if sex == "‡∏´‡∏ç‡∏¥‡∏á": hb_low, hct_low = 12, 36
    else: hb_low, hct_low = 13, 39

    cbc_config = [("‡∏Æ‡∏µ‡πÇ‡∏°‡πÇ‡∏Å‡∏•‡∏ö‡∏¥‡∏ô (Hb)", "Hb(%)", "‡∏ä‡∏≤‡∏¢ > 13, ‡∏´‡∏ç‡∏¥‡∏á > 12 g/dl", hb_low, None), ("‡∏Æ‡∏µ‡∏°‡∏≤‡πÇ‡∏ï‡∏Ñ‡∏£‡∏¥‡∏ï (Hct)", "HCT", "‡∏ä‡∏≤‡∏¢ > 39%, ‡∏´‡∏ç‡∏¥‡∏á > 36%", hct_low, None), ("‡πÄ‡∏°‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏Ç‡∏≤‡∏ß (wbc)", "WBC (cumm)", "4,000 - 10,000 /cu.mm", 4000, 10000), ("‡∏ô‡∏¥‡∏ß‡πÇ‡∏ó‡∏£‡∏ü‡∏¥‡∏• (Neutrophil)", "Ne (%)", "43 - 70%", 43, 70), ("‡∏•‡∏¥‡∏°‡πÇ‡∏ü‡πÑ‡∏ã‡∏ï‡πå (Lymphocyte)", "Ly (%)", "20 - 44%", 20, 44), ("‡πÇ‡∏°‡πÇ‡∏ô‡πÑ‡∏ã‡∏ï‡πå (Monocyte)", "M", "3 - 9%", 3, 9), ("‡∏≠‡∏µ‡πÇ‡∏≠‡∏ã‡∏¥‡πÇ‡∏ô‡∏ü‡∏¥‡∏• (Eosinophil)", "Eo", "0 - 9%", 0, 9), ("‡πÄ‡∏ö‡πÇ‡∏ã‡∏ü‡∏¥‡∏• (Basophil)", "BA", "0 - 3%", 0, 3), ("‡πÄ‡∏Å‡∏•‡πá‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î (Platelet)", "Plt (/mm)", "150,000 - 500,000 /cu.mm", 150000, 500000)]
    cbc_rows = [[(label, is_abn), (result, is_abn), (norm, is_abn)] for label, col, norm, low, high in cbc_config for val in [get_float(col, person)] for result, is_abn in [flag(val, low, high)]]
    
    blood_config = [("‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î (FBS)", "FBS", "74 - 106 mg/dl", 74, 106, False), ("‡∏Å‡∏£‡∏î‡∏¢‡∏π‡∏£‡∏¥‡∏Å (Uric Acid)", "Uric Acid", "2.6 - 7.2 mg%", 2.6, 7.2, False), ("‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏≠‡∏ô‡πÑ‡∏ã‡∏°‡πå‡∏ï‡∏±‡∏ö (ALK)", "ALP", "30 - 120 U/L", 30, 120, False), ("‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏≠‡∏ô‡πÑ‡∏ã‡∏°‡πå‡∏ï‡∏±‡∏ö (SGOT)", "SGOT", "< 37 U/L", None, 37, False), ("‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏≠‡∏ô‡πÑ‡∏ã‡∏°‡πå‡∏ï‡∏±‡∏ö (SGPT)", "SGPT", "< 41 U/L", None, 41, False), ("‡∏Ñ‡∏•‡∏≠‡πÄ‡∏£‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡∏≠‡∏• (CHOL)", "CHOL", "150 - 200 mg/dl", 150, 200, False), ("‡πÑ‡∏ï‡∏£‡∏Å‡∏•‡∏µ‡πÄ‡∏ã‡∏≠‡πÑ‡∏£‡∏î‡πå (TGL)", "TGL", "35 - 150 mg/dl", 35, 150, False), ("‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏î‡∏µ (HDL)", "HDL", "> 40 mg/dl", 40, None, True), ("‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡πÄ‡∏•‡∏ß (LDL)", "LDL", "0 - 160 mg/dl", 0, 160, False), ("‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÑ‡∏ï (BUN)", "BUN", "7.9 - 20 mg/dl", 7.9, 20, False), ("‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÑ‡∏ï (Cr)", "Cr", "0.5 - 1.17 mg/dl", 0.5, 1.17, False), ("‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÑ‡∏ï (GFR)", "GFR", "> 60 mL/min", 60, None, True)]
    blood_rows = [[(label, is_abn), (result, is_abn), (norm, is_abn)] for label, col, norm, low, high, higher in blood_config for val in [get_float(col, person)] for result, is_abn in [flag(val, low, high, higher)]]

    _, col1, col2, _ = st.columns([0.5, 3, 3, 0.5])
    with col1: st.markdown(render_lab_table_html("‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à CBC (Complete Blood Count)", None, ["‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à", "‡∏ú‡∏•", "‡∏Ñ‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥"], cbc_rows), unsafe_allow_html=True)
    with col2: st.markdown(render_lab_table_html("‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏•‡∏∑‡∏≠‡∏î (Blood Chemistry)", None, ["‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à", "‡∏ú‡∏•", "‡∏Ñ‡πà‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥"], blood_rows), unsafe_allow_html=True)

    advice_list = [kidney_advice_from_summary(kidney_summary_gfr_only(person.get("GFR", ""))), fbs_advice(person.get("FBS", "")), liver_advice(summarize_liver(person.get("ALP", ""), person.get("SGOT", ""), person.get("SGPT", ""))), uric_acid_advice(person.get("Uric Acid", "")), lipids_advice(summarize_lipids(person.get("CHOL", ""), person.get("TGL", ""), person.get("LDL", ""))), cbc_advice(person.get("Hb(%)", ""), person.get("HCT", ""), person.get("WBC (cumm)", ""), person.get("Plt (/mm)", ""), sex=sex)]
    _, main_col, _ = st.columns([0.5, 6, 0.5])
    with main_col:
        final_advice_html = merge_final_advice_grouped(advice_list)
        bg_color = "rgba(255, 255, 0, 0.2)" if "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" not in final_advice_html else "rgba(57, 255, 20, 0.2)"
        st.markdown(f"<div style='background-color:{bg_color}; padding:1rem 2.5rem; border-radius:10px; line-height:1.5; font-size:14px;'>{final_advice_html}</div>", unsafe_allow_html=True)
    
    _, col_ua_left, col_ua_right, _ = st.columns([0.5, 3, 3, 0.5])
    with col_ua_left:
        render_urine_section(person, sex, person.get("Year"))
        st.markdown(render_section_header("‡∏ú‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏∏‡∏à‡∏à‡∏≤‡∏£‡∏∞ (Stool Examination)"), unsafe_allow_html=True)
        st.markdown(render_stool_html_table(interpret_stool_exam(person.get("Stool exam", "")), interpret_stool_cs(person.get("Stool C/S", ""))), unsafe_allow_html=True)
    with col_ua_right:
        st.markdown(render_section_header("‡∏ú‡∏•‡πÄ‡∏≠‡∏Å‡∏ã‡πÄ‡∏£‡∏¢‡πå (Chest X-ray)"), unsafe_allow_html=True)
        st.markdown(f"<div style='padding:1.25rem; border-radius:6px; margin-bottom:1.5rem; font-size:14px;'>{interpret_cxr(person.get(get_ekg_col_name(person.get('Year')).replace('EKG', 'CXR'), ''))}</div>", unsafe_allow_html=True)
        st.markdown(render_section_header("‡∏ú‡∏•‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏´‡∏±‡∏ß‡πÉ‡∏à (EKG)"), unsafe_allow_html=True)
        st.markdown(f"<div style='padding:1.25rem; border-radius:6px; margin-bottom:1.5rem; font-size:14px;'>{interpret_ekg(person.get(get_ekg_col_name(person.get('Year')), ''))}</div>", unsafe_allow_html=True)
        st.markdown(render_section_header("‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏ß‡∏£‡∏±‡∏™‡∏ï‡∏±‡∏ö‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö‡πÄ‡∏≠ (Viral hepatitis A)"), unsafe_allow_html=True)
        st.markdown(f"<div style='padding:1rem; border-radius:6px; margin-bottom:1.5rem; font-size:14px;'>{safe_text(person.get('Hepatitis A'))}</div>", unsafe_allow_html=True)
        st.markdown(render_section_header("‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏ß‡∏£‡∏±‡∏™‡∏ï‡∏±‡∏ö‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö‡∏ö‡∏µ (Viral hepatitis B)"), unsafe_allow_html=True)
        hbsag, hbsab, hbcab = safe_text(person.get("HbsAg")), safe_text(person.get("HbsAb")), safe_text(person.get("HBcAB"))
        st.markdown(f"<div style='margin-bottom:1rem;'><table style='width:100%;text-align:center;border-collapse:collapse;font-size:14px;'><thead><tr><th>HBsAg</th><th>HBsAb</th><th>HBcAb</th></tr></thead><tbody><tr><td>{hbsag}</td><td>{hbsab}</td><td>{hbcab}</td></tr></tbody></table></div>", unsafe_allow_html=True)
        advice = hepatitis_b_advice(hbsag, hbsab, hbcab)
        bg_hep = "rgba(57, 255, 20, 0.2)" if "‡∏°‡∏µ‡∏†‡∏π‡∏°‡∏¥‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô" in advice else "rgba(255, 255, 0, 0.2)"
        st.markdown(f"<div style='padding:1rem 1.5rem; border-radius:6px; background-color:{bg_hep}; margin-bottom:1.5rem; font-size:14px;'>{advice}</div>", unsafe_allow_html=True)

    _, doctor_col, _ = st.columns([0.5, 6, 0.5])
    with doctor_col:
        doctor_suggestion = str(person.get("DOCTER suggest", "")).strip()
        if is_empty(doctor_suggestion): doctor_suggestion = "<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å‡πÅ‡∏û‡∏ó‡∏¢‡πå</i>"
        st.markdown(f"""
            <div style='background-color:#1b5e20; color:white; padding:1.5rem 2rem; border-radius:8px; margin-top:2rem; margin-bottom:2rem; font-size:14px;'>
                <b>‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ó‡∏¢‡πå:</b><br>{doctor_suggestion}
            </div>
            <div style='margin-top:7rem; text-align:right; padding-right:1rem;'>
                <div style='display:inline-block; text-align:center; width:340px;'>
                    <div style='border-bottom:1px dotted #ccc; margin-bottom:0.5rem; width:100%;'></div>
                    <div style='white-space:nowrap;'>‡∏ô‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ô‡∏û‡∏£‡∏±‡∏ï‡∏ô‡πå ‡∏£‡∏±‡∏ä‡∏é‡∏≤‡∏û‡∏£</div>
                    <div style='white-space:nowrap;'>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û‡πÄ‡∏ß‡∏ä‡∏Å‡∏£‡∏£‡∏° ‡∏ß.26674</div>
                </div>
            </div>
        """, unsafe_allow_html=True)
